<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Messmisan Messenger</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<!-- Optional: Google Fonts for 'Roboto' or other modern fonts -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<!-- Additional Google Fonts for new styles -->
<link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@300;400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Indie+Flower:wght@300;400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Gochi+Hand&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Satisfy&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Shadows+Into+Light&display=swap" rel="stylesheet">


<style>
/* Modern Design Theme */
:root {
    /* Default Dark Theme */
    --primary-color: #6200EE; /* Deep Purple */
    --secondary-color: #BB86FC; /* Light Purple */
    --accent-color: #03DAC6; /* Teal */
    --background-dark: #121212; /* Dark Gray (almost black) */
    --background-light: #1E1E1E; /* Slightly lighter dark gray */
    --text-color: #E0E0E0; /* Light Gray */
    --input-bg: #2C2C2C; /* Medium Dark Gray */
    --border-color: #3A3A3A; /* Darker Gray for borders */
    --bubble-sent: #6200EE; /* Deep Purple for sent */
    --bubble-received: #3A3A3A; /* Darker Gray for received */
    --notification-bg: #03DAC6; /* Teal for notifications */
    --notification-text: #121212; /* Dark text for notifications */
    --logout-btn-bg: #CF6679; /* Muted Red */
    --logout-btn-hover: #B00020; /* Darker Red */
    --online-color: #03DAC6; /* Teal */
    --offline-color: #888888; /* Medium Gray */
    --bubble-text-light: #E0E0E0; /* Light Gray for received bubbles */
    --bubble-text-dark: #FFFFFF; /* White for sent bubbles */

    /* Theme 1: Ocean Breeze */
    --ocean-primary: #007BFF; /* Blue */
    --ocean-secondary: #66B2FF; /* Lighter Blue */
    --ocean-accent: #17A2B8; /* Cyan */
    --ocean-bg-dark: #0A192F; /* Dark Blue */
    --ocean-bg-light: #1C2B40; /* Medium Dark Blue */
    --ocean-text: #E0F2F7; /* Light Blue-Gray */
    --ocean-input-bg: #2A3B50;
    --ocean-border: #3A4C60;
    --ocean-bubble-sent: #007BFF;
    --ocean-bubble-received: #2A3B50;
    --ocean-notification-bg: #17A2B8;
    --ocean-notification-text: #E0F2F7;
    --ocean-logout-btn-bg: #DC3545;
    --ocean-logout-btn-hover: #C82333;
    --ocean-online: #28A745;
    --ocean-offline: #6C757D;
    --ocean-bubble-text-light: #E0F2F7;
    --ocean-bubble-text-dark: #FFFFFF;

    /* Theme 2: Forest Green */
    --forest-primary: #28A745; /* Green */
    --forest-secondary: #66BB6A; /* Lighter Green */
    --forest-accent: #FFC107; /* Yellow */
    --forest-bg-dark: #1A2A1A; /* Dark Forest Green */
    --forest-bg-light: #2A3A2A; /* Medium Forest Green */
    --forest-text: #E6F0E6;
    --forest-input-bg: #3A4A3A;
    --forest-border: #4A5A4A;
    --forest-bubble-sent: #28A745;
    --forest-bubble-received: #3A4A3A;
    --forest-notification-bg: #FFC107;
    --forest-notification-text: #1A2A1A;
    --forest-logout-btn-bg: #DC3545;
    --forest-logout-btn-hover: #C82333;
    --forest-online: #007BFF;
    --forest-offline: #6C757D;
    --forest-bubble-text-light: #E6F0E6;
    --forest-bubble-text-dark: #FFFFFF;

    /* Theme 3: Sunset Glow */
    --sunset-primary: #FD7E14; /* Orange */
    --sunset-secondary: #FFC107; /* Yellow */
    --sunset-accent: #6F42C1; /* Purple */
    --sunset-bg-dark: #2C2C2C; /* Dark Gray */
    --sunset-bg-light: #3A3A3A; /* Medium Gray */
    --sunset-text: #F8F9FA;
    --sunset-input-bg: #4A4A4A;
    --sunset-border: #5A5A5A;
    --sunset-bubble-sent: #FD7E14;
    --sunset-bubble-received: #4A4A4A;
    --sunset-notification-bg: #6F42C1;
    --sunset-notification-text: #F8F9FA;
    --sunset-logout-btn-bg: #DC3545;
    --sunset-logout-btn-hover: #C82333;
    --sunset-online: #28A745;
    --sunset-offline: #6C757D;
    --sunset-bubble-text-light: #F8F9FA;
    --sunset-bubble-text-dark: #FFFFFF;

    /* Theme 4: Royal Blue */
    --royal-primary: #4169E1; /* Royal Blue */
    --royal-secondary: #87CEEB; /* Sky Blue */
    --royal-accent: #FFD700; /* Gold */
    --royal-bg-dark: #0D1A2B;
    --royal-bg-light: #1A2B3C;
    --royal-text: #E0EBF5;
    --royal-input-bg: #2A3C4D;
    --royal-border: #3A4D5E;
    --royal-bubble-sent: #4169E1;
    --royal-bubble-received: #2A3C4D;
    --royal-notification-bg: #FFD700;
    --royal-notification-text: #0D1A2B;
    --royal-logout-btn-bg: #DC3545;
    --royal-logout-btn-hover: #C82333;
    --royal-online: #32CD32;
    --royal-offline: #6C757D;
    --royal-bubble-text-light: #E0EBF5;
    --royal-bubble-text-dark: #FFFFFF;

    /* Theme 5: Emerald City */
    --emerald-primary: #008080; /* Teal Green */
    --emerald-secondary: #40E0D0; /* Turquoise */
    --emerald-accent: #FF4500; /* Orange Red */
    --emerald-bg-dark: #0F2027;
    --emerald-bg-light: #203A43;
    --emerald-text: #E0F0F0;
    --emerald-input-bg: #304E58;
    --emerald-border: #405E68;
    --emerald-bubble-sent: #008080;
    --emerald-bubble-received: #304E58;
    --emerald-notification-bg: #FF4500;
    --emerald-notification-text: #E0F0F0;
    --emerald-logout-btn-bg: #DC3545;
    --emerald-logout-btn-hover: #C82333;
    --emerald-online: #228B22;
    --emerald-offline: #6C757D;
    --emerald-bubble-text-light: #E0F0F0;
    --emerald-bubble-text-dark: #FFFFFF;

    /* Theme 6: Rose Gold */
    --rose-primary: #B76E79; /* Rose Gold */
    --rose-secondary: #E0BBE4; /* Light Pink */
    --rose-accent: #957DAD; /* Lavender */
    --rose-bg-dark: #2C2C2C;
    --rose-bg-light: #3A3A3A;
    --rose-text: #F5F5DC; /* Beige */
    --rose-input-bg: #4A4A4A;
    --rose-border: #5A5A5A;
    --rose-bubble-sent: #B76E79;
    --rose-bubble-received: #4A4A4A;
    --rose-notification-bg: #957DAD;
    --rose-notification-text: #F5F5DC;
    --rose-logout-btn-bg: #DC3545;
    --rose-logout-btn-hover: #C82333;
    --rose-online: #28A745;
    --rose-offline: #6C757D;
    --rose-bubble-text-light: #F5F5DC;
    --rose-bubble-text-dark: #FFFFFF;

    /* Theme 7: Midnight Blue */
    --midnight-primary: #191970; /* Midnight Blue */
    --midnight-secondary: #4682B4; /* Steel Blue */
    --midnight-accent: #FFD700; /* Gold */
    --midnight-bg-dark: #0A0A1A;
    --midnight-bg-light: #1A1A2A;
    --midnight-text: #E0E0F0;
    --midnight-input-bg: #2A2A3A;
    --midnight-border: #3A3A4A;
    --midnight-bubble-sent: #191970;
    --midnight-bubble-received: #2A2A3A;
    --midnight-notification-bg: #FFD700;
    --midnight-notification-text: #0A1A1A;
    --midnight-logout-btn-bg: #DC3545;
    --midnight-logout-btn-hover: #C82333;
    --midnight-online: #32CD32;
    --midnight-offline: #6C757D;
    --midnight-bubble-text-light: #E0E0F0;
    --midnight-bubble-text-dark: #FFFFFF;

    /* Theme 8: Warm Earth */
    --earth-primary: #A0522D; /* Sienna */
    --earth-secondary: #D2B48C; /* Tan */
    --earth-accent: #8B4513; /* Saddle Brown */
    --earth-bg-dark: #362F2D;
    --earth-bg-light: #4A423F;
    --earth-text: #F5DEB3; /* Wheat */
    --earth-input-bg: #5A524F;
    --earth-border: #6A625F;
    --earth-bubble-sent: #A0522D;
    --earth-bubble-received: #5A524F;
    --earth-notification-bg: #8B4513;
    --earth-notification-text: #F5DEB3;
    --earth-logout-btn-bg: #DC3545;
    --earth-logout-btn-hover: #C82333;
    --earth-online: #28A745;
    --earth-offline: #6C757D;
    --earth-bubble-text-light: #F5DEB3;
    --earth-bubble-text-dark: #FFFFFF;

    /* Theme 9: Cool Gray */
    --coolgray-primary: #6C757D; /* Gray */
    --coolgray-secondary: #ADB5BD; /* Light Gray */
    --coolgray-accent: #007BFF; /* Blue */
    --coolgray-bg-dark: #212529;
    --coolgray-bg-light: #343A40;
    --coolgray-text: #F8F9FA;
    --coolgray-input-bg: #495057;
    --coolgray-border: #6C757D;
    --coolgray-bubble-sent: #6C757D;
    --coolgray-bubble-received: #495057;
    --coolgray-notification-bg: #007BFF;
    --coolgray-notification-text: #F8F9FA;
    --coolgray-logout-btn-bg: #DC3545;
    --coolgray-logout-btn-hover: #C82333;
    --coolgray-online: #28A745;
    --coolgray-offline: #6C757D;
    --coolgray-bubble-text-light: #F8F9FA;
    --coolgray-bubble-text-dark: #FFFFFF;

    /* Theme 10: Pastel Dream */
    --pastel-primary: #FF69B4; /* Hot Pink */
    --pastel-secondary: #FFB6C1; /* Light Pink */
    --pastel-accent: #87CEEB; /* Sky Blue */
    --pastel-bg-dark: #F0F8FF; /* Alice Blue */
    --pastel-bg-light: #F8F8FF; /* Ghost White */
    --pastel-text: #36454F; /* Charcoal */
    --pastel-input-bg: #E6E6FA; /* Lavender */
    --pastel-border: #DDA0DD; /* Plum */
    --pastel-bubble-sent: #FF69B4;
    --pastel-bubble-received: #E6E6FA;
    --pastel-notification-bg: #87CEEB;
    --pastel-notification-text: #36454F;
    --pastel-logout-btn-bg: #DC3545;
    --pastel-logout-btn-hover: #C82333;
    --pastel-online: #28A745;
    --pastel-offline: #6C757D;
    --pastel-bubble-text-light: #36454F;
    --pastel-bubble-text-dark: #FFFFFF;
}

/* Theme Classes */
body.theme-default {
    --primary-color: var(--primary-color);
    --secondary-color: var(--secondary-color);
    --accent-color: var(--accent-color);
    --background-dark: var(--background-dark);
    --background-light: var(--background-light);
    --text-color: var(--text-color);
    --input-bg: var(--input-bg);
    --border-color: var(--border-color);
    --bubble-sent: var(--bubble-sent);
    --bubble-received: var(--bubble-received);
    --notification-bg: var(--notification-bg);
    --notification-text: var(--notification-text);
    --logout-btn-bg: var(--logout-btn-bg);
    --logout-btn-hover: var(--logout-btn-hover);
    --online-color: var(--online-color);
    --offline-color: var(--offline-color);
    --bubble-text-light: var(--bubble-text-light);
    --bubble-text-dark: var(--bubble-text-dark);
}

body.theme-ocean-breeze {
    --primary-color: var(--ocean-primary);
    --secondary-color: var(--ocean-secondary);
    --accent-color: var(--ocean-accent);
    --background-dark: var(--ocean-bg-dark);
    --background-light: var(--ocean-bg-light);
    --text-color: var(--ocean-text);
    --input-bg: var(--ocean-input-bg);
    --border-color: var(--ocean-border);
    --bubble-sent: var(--ocean-bubble-sent);
    --bubble-received: var(--ocean-bubble-received);
    --notification-bg: var(--ocean-notification-bg);
    --notification-text: var(--ocean-notification-text);
    --logout-btn-bg: var(--ocean-logout-btn-bg);
    --logout-btn-hover: var(--ocean-logout-btn-hover);
    --online-color: var(--ocean-online);
    --offline-color: var(--ocean-offline);
    --bubble-text-light: var(--ocean-bubble-text-light);
    --ocean-bubble-text-dark: #FFFFFF;
}

body.theme-forest-green {
    --primary-color: var(--forest-primary);
    --secondary-color: var(--forest-secondary);
    --accent-color: var(--forest-accent);
    --background-dark: var(--forest-bg-dark);
    --background-light: var(--forest-bg-light);
    --text-color: var(--forest-text);
    --input-bg: var(--forest-input-bg);
    --border-color: var(--forest-border);
    --bubble-sent: var(--forest-bubble-sent);
    --bubble-received: var(--forest-bubble-received);
    --notification-bg: var(--forest-notification-bg);
    --notification-text: var(--forest-notification-text);
    --logout-btn-bg: var(--forest-logout-btn-bg);
    --logout-btn-hover: var(--forest-logout-btn-hover);
    --online-color: var(--forest-online);
    --offline-color: var(--forest-offline);
    --bubble-text-light: var(--forest-bubble-text-light);
    --forest-bubble-text-dark: #FFFFFF;
}

body.theme-sunset-glow {
    --primary-color: var(--sunset-primary);
    --secondary-color: var(--sunset-secondary);
    --accent-color: var(--sunset-accent);
    --background-dark: var(--sunset-bg-dark);
    --background-light: var(--sunset-bg-light);
    --text-color: var(--sunset-text);
    --input-bg: var(--sunset-input-bg);
    --border-color: var(--sunset-border);
    --bubble-sent: var(--sunset-bubble-sent);
    --bubble-received: var(--sunset-bubble-received);
    --notification-bg: var(--sunset-notification-bg);
    --sunset-notification-text: #F8F9FA;
    --logout-btn-bg: var(--sunset-logout-btn-bg);
    --logout-btn-hover: var(--sunset-logout-btn-hover);
    --online-color: var(--sunset-online);
    --offline-color: var(--sunset-offline);
    --bubble-text-light: var(--sunset-bubble-text-light);
    --sunset-bubble-text-dark: #FFFFFF;
}

body.theme-royal-blue {
    --primary-color: var(--royal-primary);
    --secondary-color: var(--royal-secondary);
    --accent-color: var(--royal-accent);
    --background-dark: var(--royal-bg-dark);
    --background-light: var(--royal-bg-light);
    --text-color: var(--royal-text);
    --input-bg: var(--royal-input-bg);
    --border-color: var(--royal-border);
    --bubble-sent: var(--royal-bubble-sent);
    --bubble-received: var(--royal-bubble-received);
    --notification-bg: var(--royal-notification-bg);
    --royal-notification-text: #0D1A2B;
    --logout-btn-bg: var(--royal-logout-btn-bg);
    --logout-btn-hover: var(--royal-logout-btn-hover);
    --online-color: var(--royal-online);
    --offline-color: var(--royal-offline);
    --bubble-text-light: var(--royal-bubble-text-light);
    --royal-bubble-text-dark: #FFFFFF;
}

body.theme-emerald-city {
    --primary-color: var(--emerald-primary);
    --secondary-color: var(--emerald-secondary);
    --accent-color: var(--emerald-accent);
    --background-dark: var(--emerald-bg-dark);
    --background-light: var(--emerald-bg-light);
    --text-color: var(--emerald-text);
    --input-bg: var(--emerald-input-bg);
    --border-color: var(--emerald-border);
    --bubble-sent: var(--emerald-bubble-sent);
    --bubble-received: var(--emerald-bubble-received);
    --notification-bg: var(--emerald-notification-bg);
    --emerald-notification-text: #E0F0F0;
    --logout-btn-bg: var(--emerald-logout-btn-bg);
    --logout-btn-hover: #C82333;
    --online-color: var(--emerald-online);
    --offline-color: #6C757D;
    --bubble-text-light: var(--emerald-bubble-text-light);
    --emerald-bubble-text-dark: #FFFFFF;
}

body.theme-rose-gold {
    --primary-color: var(--rose-primary);
    --secondary-color: var(--rose-secondary);
    --accent-color: var(--rose-accent);
    --background-dark: var(--rose-bg-dark);
    --background-light: var(--rose-bg-light);
    --text-color: var(--rose-text);
    --input-bg: var(--rose-input-bg);
    --rose-border: #5A5A5A;
    --rose-bubble-sent: #B76E79;
    --rose-bubble-received: #4A4A4A;
    --rose-notification-bg: #957DAD;
    --rose-notification-text: #F5F5DC;
    --rose-logout-btn-bg: #DC3545;
    --rose-logout-btn-hover: #C82333;
    --rose-online: #28A745;
    --rose-offline: #6C757D;
    --rose-bubble-text-light: #F5F5DC;
    --rose-bubble-text-dark: #FFFFFF;
}

body.theme-midnight-blue {
    --primary-color: var(--midnight-primary);
    --secondary-color: var(--midnight-secondary);
    --accent-color: var(--midnight-accent);
    --background-dark: var(--midnight-bg-dark);
    --background-light: var(--midnight-bg-light);
    --text-color: var(--midnight-text);
    --input-bg: var(--midnight-input-bg);
    --midnight-border: #3A3A4A;
    --midnight-bubble-sent: #191970;
    --midnight-bubble-received: #2A2A3A;
    --midnight-notification-bg: #FFD700;
    --midnight-notification-text: #0A1A1A;
    --midnight-logout-btn-bg: #DC3545;
    --midnight-logout-btn-hover: #C82333;
    --midnight-online: #32CD32;
    --midnight-offline: #6C757D;
    --midnight-bubble-text-light: #E0E0F0;
    --midnight-bubble-text-dark: #FFFFFF;
}

body.theme-warm-earth {
    --primary-color: var(--earth-primary);
    --secondary-color: var(--earth-secondary);
    --accent-color: var(--earth-accent);
    --earth-bg-dark: #362F2D;
    --earth-bg-light: #4A423F;
    --earth-text: #F5DEB3; /* Wheat */
    --earth-input-bg: #5A524F;
    --earth-border: #6A625F;
    --earth-bubble-sent: #A0522D;
    --earth-bubble-received: #5A524F;
    --earth-notification-bg: #8B4513;
    --earth-notification-text: #F5DEB3;
    --earth-logout-btn-bg: #DC3545;
    --earth-logout-btn-hover: #C82333;
    --earth-online: #28A745;
    --earth-offline: #6C757D;
    --earth-bubble-text-light: #F5DEB3;
    --earth-bubble-text-dark: #FFFFFF;
}

body.theme-cool-gray {
    --primary-color: var(--coolgray-primary);
    --secondary-color: var(--coolgray-secondary);
    --coolgray-accent: #007BFF; /* Blue */
    --coolgray-bg-dark: #212529;
    --coolgray-bg-light: #343A40;
    --coolgray-text: #F8F9FA;
    --coolgray-input-bg: #495057;
    --coolgray-border: #6C757D;
    --coolgray-bubble-sent: #6C757D;
    --coolgray-bubble-received: #495057;
    --coolgray-notification-bg: #007BFF;
    --coolgray-notification-text: #F8F9FA;
    --coolgray-logout-btn-bg: #DC3545;
    --coolgray-logout-btn-hover: #C82333;
    --coolgray-online: #28A745;
    --coolgray-offline: #6C757D;
    --coolgray-bubble-text-light: #F8F9FA;
    --coolgray-bubble-text-dark: #FFFFFF;
}

body.theme-pastel-dream {
    --primary-color: var(--pastel-primary);
    --secondary-color: var(--pastel-secondary);
    --pastel-accent: #87CEEB; /* Sky Blue */
    --pastel-bg-dark: #F0F8FF; /* Alice Blue */
    --pastel-bg-light: #F8F8FF; /* Ghost White */
    --pastel-text: #36454F; /* Charcoal */
    --pastel-input-bg: #E6E6FA; /* Lavender */
    --pastel-border: #DDA0DD;
    --pastel-bubble-sent: #FF69B4;
    --pastel-bubble-received: #E6E6FA;
    --pastel-notification-bg: #87CEEB;
    --pastel-notification-text: #36454F;
    --pastel-logout-btn-bg: #DC3545;
    --pastel-logout-btn-hover: #C82333;
    --pastel-online: #28A745;
    --pastel-offline: #6C757D;
    --pastel-bubble-text-light: #36454F;
    --pastel-bubble-text-dark: #FFFFFF;
}


/* Font Families */
    --font-family-default: 'Roboto', sans-serif;
    --font-family-playful: 'Comic Neue', cursive;
    --font-family-fancy: 'Dancing Script', cursive;
    --font-family-blocky: 'Press Start 2P', cursive;
    --font-family-cute: 'Pacifico', cursive;
    --font-family-handwritten: 'Caveat', cursive;
    --font-family-modern: 'Montserrat', sans-serif;
    --font-family-pixel: 'Press Start 2P', cursive;
    --font-family-elegant: 'Lora', serif;
    --font-family-funky: 'Bangers', cursive;
    --font-family-quirky: 'Indie Flower', cursive;
    --font-family-tech: 'Share Tech Mono', monospace;
    --font-family-retro: 'Permanent Marker', cursive;
    --font-family-storybook: 'Gochi Hand', cursive;
    --font-family-classic: 'Merriweather', serif;
    --font-family-minimal: 'Open Sans', sans-serif;
    --font-family-clean: 'Lato', sans-serif;
    --font-family-geometric: 'Ubuntu', sans-serif;
    --font-family-serif-display: 'Playfair Display', serif;
    --font-family-script: 'Satisfy', cursive;
    --font-family-marker: 'Shadows Into Light', cursive;
    --font-family-bold-modern: 'Oswald', sans-serif;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: var(--font-family-default); /* Use default font variable */
    background-color: var(--background-dark);
    color: var(--text-color);
    width: 100vw;
    height: 100vh;
    overflow: hidden; /* Default to hidden for desktop, handled by media query for mobile */
    transition: background-color 0.3s ease, color 0.3s ease, font-family 0.3s ease;
}

/* Font Style Classes */
body.font-style-playful {
    font-family: var(--font-family-playful);
}
body.font-style-fancy {
    font-family: var(--font-family-fancy);
}
body.font-style-blocky {
    font-family: var(--font-family-blocky);
}
body.font-style-cute {
    font-family: var(--font-family-cute);
}
body.font-style-handwritten {
    font-family: var(--font-family-handwritten);
}
body.font-style-modern {
    font-family: var(--font-family-modern);
}
body.font-style-pixel {
    font-family: var(--font-family-pixel);
}
body.font-style-elegant {
    font-family: var(--font-family-elegant);
}
body.font-style-funky {
    font-family: var(--font-family-funky);
}
body.font-style-quirky {
    font-family: var(--font-family-quirky);
}
body.font-style-tech {
    font-family: var(--font-family-tech);
}
body.font-style-retro {
    font-family: var(--font-family-retro);
}
body.font-style-storybook {
    font-family: var(--font-family-storybook);
}
body.font-style-classic {
    font-family: var(--font-family-classic);
}
body.font-style-minimal {
    font-family: var(--font-family-minimal);
}
body.font-style-clean {
    font-family: var(--font-family-clean);
}
body.font-style-geometric {
    font-family: var(--font-family-geometric);
}
body.font-style-serif-display {
    font-family: var(--font-family-serif-display);
}
body.font-style-script {
    font-family: var(--font-family-script);
}
body.font-style-marker {
    font-family: var(--font-family-marker);
}
body.font-style-bold-modern {
    font-family: var(--font-family-bold-modern);
}


.main-container {
    display: flex;
    width: 100%;
    height: 100%;
    background-color: var(--background-dark);
    position: relative;
    transition: background-color 0.3s ease;
}

/* Page Layouts */
.page {
    width: 100%;
    height: 100%; /* Default for desktop */
    display: none; /* Hidden by default */
    flex-direction: column;
    background-color: var(--background-dark);
    color: var(--text-color);
    position: relative; /* For dynamic background */
    overflow: hidden; /* Hide overflow from floating elements */
}
.page.active {
    display: flex; /* Show active page */
}

/* Dynamic Background */
.dynamic-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    z-index: 0; /* Behind content */
    pointer-events: none; /* Allow clicks to pass through */
}

.dynamic-background div {
    position: absolute;
    background: var(--accent-color); /* Use accent color for elements */
    border-radius: 50%;
    opacity: 0.1; /* More subtle */
    animation: float 15s infinite ease-in-out alternate; /* Slower animation */
}

.dynamic-background div:nth-child(1) { width: 40px; height: 40px; top: 10%; left: 5%; animation-duration: 18s; animation-delay: 0s; }
.dynamic-background div:nth-child(2) { width: 60px; height: 60px; top: 20%; left: 80%; animation-duration: 20s; animation-delay: 2s; }
.dynamic-background div:nth-child(3) { width: 50px; height: 50px; top: 40%; left: 20%; animation-duration: 16s; animation-delay: 4s; }
.dynamic-background div:nth-child(4) { width: 70px; height: 70px; top: 60%; left: 90%; animation-duration: 22s; animation-delay: 6s; }
.dynamic-background div:nth-child(5) { width: 45px; height: 45px; top: 80%; left: 10%; animation-duration: 19s; animation-delay: 8s; }
.dynamic-background div:nth-child(6) { width: 55px; height: 55px; top: 5%; left: 50%; animation-duration: 21s; animation-delay: 1s; }
.dynamic-background div:nth-child(7) { width: 65px; height: 65px; top: 70%; left: 30%; animation-duration: 17s; animation-delay: 3s; }
.dynamic-background div:nth-child(8) { width: 35px; height: 35px; top: 30%; left: 70%; animation-duration: 15s; animation-delay: 5s; }
.dynamic-background div:nth-child(9) { width: 75px; height: 75px; top: 90%; left: 60%; animation-duration: 23s; animation-delay: 7s; }
.dynamic-background div:nth-child(10) { width: 40px; height: 40px; top: 50%; left: 5%; animation-duration: 18.5s; animation-delay: 9s; }

@keyframes float {
    0% { transform: translateY(0) translateX(0) rotate(0deg); }
    50% { transform: translateY(-30px) translateX(15px) rotate(15deg); } /* More subtle movement */
    100% { transform: translateY(0) translateX(0) rotate(0deg); }
}

/* Auth Container */
.auth-container {
    display: flex;
    flex-direction: column;
    padding: 30px; /* Slightly less padding */
    max-width: 400px; /* Slightly narrower */
    margin: auto;
    background-color: var(--background-light); /* Solid background */
    border-radius: 12px; /* Modern rounded corners */
    box-shadow: 0 6px 15px rgba(0,0,0,0.4); /* Softer shadow */
    animation: fadeIn 0.5s ease-out;
    transition: background-color 0.3s ease;
    position: relative;
    z-index: 1;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}
.auth-container input, .auth-container button {
    margin-bottom: 12px; /* Reduced margin */
    padding: 12px; /* Reduced padding */
    border-radius: 8px; /* Modern rounded inputs */
    border: 1px solid var(--border-color); /* Subtle border */
    font-size: 1rem;
    background: var(--input-bg);
    color: var(--text-color);
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); /* Softer inset shadow */
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, font-family 0.3s ease;
}
.auth-container input::placeholder {
    color: var(--text-color); /* Placeholder color */
    opacity: 0.6;
}
.auth-container button {
    background-color: var(--primary-color);
    color: var(--bubble-text-dark); /* White text for primary button */
    font-weight: 500; /* Medium weight */
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: background-color 0.2s ease, transform 0.1s ease, color 0.3s ease, box-shadow 0.2s ease, font-family 0.3s ease;
    box-shadow: 0 3px 8px rgba(0,0,0,0.3);
}
.auth-container button:hover {
    background-color: var(--secondary-color);
    transform: translateY(-1px);
    box-shadow: 0 5px 12px rgba(0,0,0,0.4);
}
.auth-container button:active {
    transform: translateY(0);
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.auth-container h2 {
    text-align: center;
    color: var(--accent-color);
    margin-bottom: 25px; /* Reduced margin */
    font-size: 2rem; /* Slightly smaller heading */
    text-shadow: none; /* No text shadow */
    transition: color 0.3s ease, font-family 0.3s ease;
}
.switch-link {
    text-align: center;
    margin-top: 12px; /* Reduced margin */
    color: var(--accent-color);
    cursor: pointer;
    font-size: 0.95rem;
    transition: color 0.2s ease, font-family 0.3s ease;
}
.switch-link:hover {
    color: var(--secondary-color);
    text-decoration: underline;
}

/* Friend List Page Specific Styles */
#friendListPage {
    padding: 20px;
    align-items: center;
    gap: 15px; /* Reduced gap */
}
#friendListPage .header {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 12px; /* Reduced padding */
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 15px; /* Reduced margin */
    position: relative;
    z-index: 1;
}
#friendListPage .header .user-info {
    font-size: 1.6rem; /* Slightly smaller user info */
    font-weight: 500; /* Medium weight */
    color: var(--accent-color);
    transition: color 0.3s ease, font-family 0.3s ease;
}
#friendListPage .header .logout-btn {
    background-color: var(--logout-btn-bg);
    color: white;
    border: none;
    border-radius: 10px; /* Modern rounded */
    padding: 8px 16px; /* Reduced padding */
    cursor: pointer;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease, font-family 0.3s ease;
    box-shadow: 0 3px 8px rgba(0,0,0,0.3);
}
#friendListPage .header .logout-btn:hover {
    background-color: var(--logout-btn-hover);
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(0,0,0,0.4);
}

#friendListPage .user-avatar-large {
    width: 90px; /* Slightly smaller avatar */
    height: 90px;
    border-radius: 50%;
    background-color: var(--input-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3.5rem; /* Slightly smaller icon */
    color: var(--accent-color);
    border: 3px solid var(--primary-color);
    margin-bottom: 15px; /* Reduced margin */
    box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    position: relative;
    z-index: 1;
    transition: color 0.3s ease, border-color 0.3s ease, background-color 0.3s ease;
}

#friendListPage .search-container {
    width: 90%; /* Wider search bar */
    max-width: 550px; /* Increased max-width */
    position: relative;
    margin-bottom: 15px; /* Reduced margin */
    z-index: 2;
}
#friendListPage .search-container input {
    width: 100%;
    padding: 10px 18px; /* Reduced padding */
    border-radius: 20px; /* Modern rounded */
    border: 1px solid var(--border-color);
    background: var(--input-bg);
    color: var(--text-color);
    font-size: 1rem;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, font-family 0.3s ease;
}
#friendListPage .search-container input::placeholder {
    color: var(--text-color);
    opacity: 0.6;
}
#friendListPage .search-results {
    position: absolute;
    top: calc(100% + 5px); /* Slightly more space */
    left: 0;
    right: 0;
    background-color: var(--background-light);
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 12px 12px; /* Modern rounded */
    max-height: 200px; /* Slightly shorter results */
    overflow-y: auto;
    z-index: 10;
    box-shadow: 0 5px 12px rgba(0,0,0,0.4);
    display: none;
    transition: background-color 0.3s ease, border-color 0.3s ease;
}
#friendListPage .search-results.visible {
    display: block;
}
.search-result-item {
    padding: 10px 15px; /* Reduced padding */
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.2s ease, font-family 0.3s ease;
}
.search-result-item:last-child {
    border-bottom: none;
}
.search-result-item:hover {
    background-color: var(--input-bg);
}
.search-result-item i {
    color: var(--accent-color);
    transition: color 0.3s ease;
}
.search-result-item .user-info-display {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-grow: 1;
    color: var(--text-color);
    transition: color 0.3s ease;
}
.add-friend-search-btn {
    background: none;
    border: none;
    color: var(--primary-color);
    font-size: 1.3rem; /* Slightly smaller icon */
    cursor: pointer;
    padding: 6px;
    border-radius: 50%;
    transition: background-color 0.2s ease, transform 0.2s ease, color 0.3s ease;
    flex-shrink: 0;
}
.add-friend-search-btn:hover {
    background-color: rgba(var(--primary-color-rgb, 98, 0, 238), 0.2); /* Use RGB for transparency */
    transform: scale(1.15);
}

#friendListPage .friends-list-section {
    width: 90%; /* Wider list */
    max-width: 550px; /* Increased max-width */
    flex-grow: 1;
    overflow-y: auto;
    padding: 12px; /* Reduced padding */
    border: 1px solid var(--border-color);
    border-radius: 12px; /* Modern rounded */
    background-color: var(--background-light); /* Solid background */
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    position: relative;
    z-index: 1;
    transition: background-color 0.3s ease, border-color 0.3s ease;
}
#friendListPage .friends-list-section::-webkit-scrollbar {
    width: 8px; /* Thinner scrollbar */
}
#friendListPage .friends-list-section::-webkit-scrollbar-track {
    background: var(--background-dark);
    border-radius: 8px;
}
#friendListPage .friends-list-section::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 8px;
}
#friendListPage .friends-list-section::-webkit-scrollbar-thumb:hover {
    background: var(--secondary-color);
}

.friend-item-large {
    display: flex;
    align-items: center;
    padding: 10px 15px; /* Reduced padding */
    margin-bottom: 8px; /* Reduced margin */
    background-color: var(--input-bg);
    border-radius: 10px; /* Modern rounded */
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
    position: relative;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2); /* Softer shadow */
}
.friend-item-large:hover {
    background-color: var(--border-color);
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
.friend-item-large .friend-info-container {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}
.friend-item-large .friend-avatar {
    width: 60px; /* Slightly smaller avatar */
    height: 60px;
    border-radius: 50%;
    background-color: var(--background-dark);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem; /* Slightly smaller icon */
    color: var(--accent-color);
    border: 2px solid var(--primary-color);
    margin-right: 12px; /* Reduced margin */
    transition: color 0.3s ease, border-color 0.3s ease, background-color 0.3s ease;
}
.friend-item-large .friend-nickname {
    font-size: 1.1rem; /* Slightly smaller nickname */
    font-weight: 500; /* Medium weight */
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 8px;
    transition: color 0.3s ease, font-family 0.3s ease;
}
.friend-item-large .latest-message-preview {
    font-size: 0.85rem; /* Slightly smaller font */
    color: var(--text-color);
    opacity: 0.7;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
    transition: color 0.3s ease, font-family 0.3s ease;
}
.friend-item-large .friend-remove-btn {
    background: none;
    border: none;
    color: var(--logout-btn-bg); /* Muted Red for remove */
    cursor: pointer;
    font-size: 1.2rem; /* Slightly smaller icon */
    padding: 6px;
    transition: transform 0.2s ease, color 0.2s ease;
}
.friend-item-large .friend-remove-btn:hover {
    transform: scale(1.2);
    color: var(--logout-btn-hover);
}

/* Online Status Indicator */
.online-status-indicator {
    width: 10px; /* Slightly smaller indicator */
    height: 10px;
    border-radius: 50%;
    background-color: var(--offline-color);
    display: inline-block;
    margin-left: 6px;
    flex-shrink: 0;
    box-shadow: 0 0 3px rgba(0,0,0,0.2);
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
}
.online-status-indicator.online {
    background-color: var(--online-color);
    box-shadow: 0 0 6px var(--online-color); /* Softer glow effect */
}

/* Chat Window Specific Styles */
#chatWindow {
    background-color: var(--background-dark);
}
#chatWindow .chat-header {
    background-color: var(--background-light);
    padding: 15px 20px; /* Reduced padding */
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    transition: background-color 0.3s ease, border-color 0.3s ease;
}
#chatWindow .chat-header .back-btn {
    background: none;
    border: none;
    color: var(--accent-color);
    font-size: 1.6rem; /* Slightly smaller icon */
    cursor: pointer;
    padding: 6px;
    transition: transform 0.2s ease, color 0.3s ease;
}
#chatWindow .chat-header .back-btn:hover {
    transform: translateX(-6px);
}
#chatWindow .chat-header .chat-with-info {
    font-weight: 500; /* Medium weight */
    color: var(--accent-color);
    font-size: 1.6rem; /* Slightly smaller text */
    flex-grow: 1;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: color 0.3s ease, font-family 0.3s ease;
}

#chatWindow .messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px; /* Reduced padding */
    display: flex;
    flex-direction: column;
    gap: 10px; /* Reduced space between bubbles */
    padding-top: 70px; /* Space for fixed header */
    padding-bottom: 80px; /* Space for fixed input */
}
#chatWindow .messages::-webkit-scrollbar {
    width: 8px;
}
#chatWindow .messages::-webkit-scrollbar-track {
    background: var(--background-dark);
    border-radius: 8px;
}
#chatWindow .messages::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 8px;
}
#chatWindow .messages::-webkit-scrollbar-thumb:hover {
    background: var(--secondary-color);
}

.bubble {
    max-width: 70%; /* Slightly narrower bubbles */
    padding: 12px 18px; /* Reduced padding */
    border-radius: 18px; /* Less rounded */
    line-height: 1.5;
    word-wrap: break-word;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2); /* Softer shadow */
    position: relative;
    transition: background-color 0.3s ease, color 0.3s ease, font-family 0.3s ease;
    font-family: inherit;
    display: flex;
    flex-direction: column;
    /* For swipe to reply */
    touch-action: pan-y; /* Allow vertical scrolling, prevent horizontal */
    transform: translateX(0);
    transition: transform 0.1s ease-out;
}
.sent {
    align-self: flex-end;
    background-color: var(--bubble-sent);
    border-bottom-right-radius: 6px; /* Subtle pointy corner */
}
.received {
    align-self: flex-start;
    background-color: var(--bubble-received);
    border-bottom-left-radius: 6px; /* Subtle pointy corner */
}
.message-content {
    margin-bottom: 4px; /* Reduced space */
}
.message-meta {
    font-size: 0.7rem; /* Smaller font for meta info */
    font-family: inherit;
    text-align: right;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 4px;
    color: var(--text-color); /* Ensure meta text is visible */
    opacity: 0.8;
}
.bubble.received .message-meta {
    justify-content: flex-start;
}
.seen-indicator {
    font-size: 0.7rem; /* Consistent with timestamp */
    font-family: inherit;
}

/* Dynamic text color for bubbles */
.bubble.sent {
    color: var(--bubble-text-dark);
}
.bubble.received {
    color: var(--bubble-text-light);
}

/* Reply button on message bubbles */
.bubble .reply-btn {
    position: absolute;
    top: 5px; /* Adjust as needed */
    right: 5px; /* Adjust as needed */
    background: none;
    border: none;
    color: var(--text-color);
    font-size: 0.8rem;
    cursor: pointer;
    opacity: 0; /* Hidden by default */
    transition: opacity 0.2s ease;
}

.bubble:hover .reply-btn {
    opacity: 1; /* Show on hover */
}

.bubble.received .reply-btn {
    left: 5px; /* Adjust for received bubbles */
    right: auto;
}

/* Swipe indicator for reply */
.bubble .swipe-indicator {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    width: 0; /* Will expand on swipe */
    background-color: var(--accent-color);
    opacity: 0.2;
    border-radius: 18px;
    transition: width 0.1s ease-out, opacity 0.1s ease-out;
    z-index: -1; /* Behind message content */
}
.bubble.received .swipe-indicator {
    left: auto;
    right: 0;
}


/* Reply preview in message input */
.reply-preview {
    background-color: var(--border-color);
    padding: 8px 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    color: var(--text-color);
    border-left: 4px solid var(--accent-color);
}

.reply-preview .reply-text {
    flex-grow: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.reply-preview .cancel-reply-btn {
    background: none;
    border: none;
    color: var(--logout-btn-bg);
    font-size: 1rem;
    cursor: pointer;
    margin-left: 10px;
}


#chatWindow .message-input {
    display: flex;
    flex-wrap: wrap;
    padding: 15px 20px; /* Reduced padding */
    border-top: 1px solid var(--border-color);
    background-color: var(--background-light);
    gap: 10px; /* Reduced gap */
    box-shadow: 0 -3px 8px rgba(0,0,0,0.3);
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 100;
    transition: background-color 0.3s ease, border-color 0.3s ease;
}
#chatWindow .message-input input {
    flex: 1;
    padding: 10px 18px; /* Reduced padding */
    background: var(--input-bg);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    border-radius: 20px; /* Modern rounded */
    font-size: 1rem;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, font-family 0.3s ease;
}
#chatWindow .message-input input::placeholder {
    color: var(--text-color);
    opacity: 0.6;
}
#chatWindow .message-input button {
    padding: 10px 20px; /* Reduced padding */
    background-color: var(--primary-color);
    border: none;
    border-radius: 20px; /* Modern rounded */
    color: var(--bubble-text-dark);
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: background-color 0.2s ease, transform 0.1s ease, color 0.3s ease, box-shadow 0.2s ease, font-family 0.3s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
#chatWindow .message-input button:hover {
    background-color: var(--secondary-color);
    transform: translateY(-1px);
}
#chatWindow .message-input button:active {
    transform: translateY(0);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.emoji-picker-btn, .attachment-btn, .camera-btn {
    color: var(--accent-color);
    cursor: pointer;
    font-size: 1.6rem; /* Slightly smaller emoji button */
    transition: all 0.2s;
}
.emoji-picker-btn:hover, .attachment-btn:hover, .camera-btn:hover {
    transform: scale(1.15);
}
.emoji-panel {
    position: absolute;
    bottom: 70px; /* Adjusted for smaller input area */
    right: 20px; /* Adjusted for smaller padding */
    background: var(--background-light);
    border-radius: 12px; /* Modern rounded */
    padding: 12px; /* Reduced padding */
    box-shadow: 0 0 12px rgba(0,0,0,0.5);
    z-index: 100;
    display: none;
    width: 280px; /* Slightly narrower */
    height: 180px; /* Slightly shorter */
    overflow-y: auto;
    transition: background-color 0.3s ease;
}
.emoji-panel.visible {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 6px; /* Reduced space between emojis */
}
.emoji-item {
    font-size: 1.6rem; /* Slightly smaller emojis */
    cursor: pointer;
    padding: 6px;
    text-align: center;
    transition: transform 0.1s;
}
.emoji-item:hover {
    transform: scale(1.2);
}

/* Attachment Input Container */
.attachment-input-container {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 6px; /* Reduced gap */
    margin-bottom: 8px; /* Reduced margin */
    padding: 8px; /* Reduced padding */
    background-color: var(--input-bg);
    border-radius: 10px; /* Modern rounded */
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    display: none;
}
.attachment-input-container.visible {
    display: flex;
}

.file-input-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
}

.file-input-wrapper label {
    background-color: var(--primary-color);
    color: var(--bubble-text-dark);
    padding: 6px 12px; /* Reduced padding */
    border-radius: 16px; /* Modern rounded */
    cursor: pointer;
    font-size: 0.85rem;
    transition: background-color 0.2s ease;
}
.file-input-wrapper label:hover {
    background-color: var(--secondary-color);
}

.file-input-wrapper input[type="file"] {
    display: none;
}

.file-preview-container {
    display: flex;
    flex-wrap: wrap;
    gap: 4px; /* Reduced gap */
    max-height: 70px; /* Reduced height */
    overflow-y: auto;
    padding-right: 4px;
}

.file-preview-item {
    background-color: var(--background-dark);
    color: var(--text-color);
    padding: 4px 8px; /* Reduced padding */
    border-radius: 8px; /* Modern rounded */
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    gap: 4px;
}

.file-preview-item .remove-file-btn {
    background: none;
    border: none;
    color: var(--logout-btn-bg);
    cursor: pointer;
    font-size: 0.8rem;
}

.attachment-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 4px;
}

.attachment-actions button {
    padding: 6px 12px; /* Reduced padding */
    border-radius: 16px; /* Modern rounded */
    border: none;
    cursor: pointer;
    font-size: 0.85rem;
    transition: background-color 0.2s ease;
}

.attachment-actions .send-attachment-btn {
    background-color: var(--notification-bg);
    color: var(--notification-text);
}
.attachment-actions .send-attachment-btn:hover {
    background-color: #00BFA5; /* Slightly darker teal */
}

.attachment-actions .attachment-clear-btn {
    background-color: var(--logout-btn-bg);
    color: var(--notification-text);
}
.attachment-actions .attachment-clear-btn:hover {
    background-color: var(--logout-btn-hover);
}

/* Camera Modal */
.camera-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1002;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}
.camera-modal-overlay.visible {
    opacity: 1;
    visibility: visible;
}
.camera-modal-content {
    background-color: var(--background-light);
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
    text-align: center;
    max-width: 90%;
    max-height: 90%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}
.camera-modal-content video {
    max-width: 100%;
    max-height: 70vh;
    background-color: black;
    border-radius: 10px;
}
.camera-modal-content canvas {
    display: none; /* Hidden until capture */
    max-width: 100%;
    max-height: 70vh;
    border-radius: 10px;
}
.camera-controls {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    justify-content: center;
}
.camera-controls button {
    padding: 10px 20px;
    border-radius: 20px;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.2s ease, transform 0.1s ease;
    background-color: var(--primary-color);
    color: var(--bubble-text-dark);
}
.camera-controls button:hover {
    background-color: var(--secondary-color);
    transform: translateY(-1px);
}
.camera-controls button.record-btn {
    background-color: #dc3545; /* Red for record */
}
.camera-controls button.record-btn:hover {
    background-color: #c82333;
}
.camera-controls button.stop-record-btn {
    background-color: #ffc107; /* Yellow for stop */
    color: var(--notification-text);
}
.camera-controls button.stop-record-btn:hover {
    background-color: #e0a800;
}
.camera-controls button.send-captured-btn {
    background-color: var(--notification-bg);
    color: var(--notification-text);
}
.camera-controls button.send-captured-btn:hover {
    background-color: #00BFA5;
}
.camera-controls button.retake-btn {
    background-color: var(--input-bg);
    color: var(--text-color);
}
.camera-controls button.retake-btn:hover {
    background-color: var(--border-color);
}


/* Add Friend Confirmation Modal */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7); /* Slightly lighter overlay */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}
.modal-overlay.visible {
    opacity: 1;
    visibility: visible;
}
.modal-content {
    background-color: var(--background-light);
    padding: 30px; /* Reduced padding */
    border-radius: 15px; /* Modern rounded */
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5); /* Softer shadow */
    text-align: center;
    max-width: 400px; /* Slightly narrower */
    width: 90%;
    transform: translateY(-20px); /* Less pronounced animation */
    transition: transform 0.3s ease, background-color 0.3s ease;
}
.modal-overlay.visible .modal-content {
    transform: translateY(0);
}
.modal-content h3 {
    color: var(--accent-color);
    margin-bottom: 20px; /* Reduced margin */
    font-size: 1.6rem; /* Slightly smaller heading */
    transition: color 0.3s ease, font-family 0.3s ease;
}
.modal-content .modal-buttons {
    display: flex;
    justify-content: center;
    gap: 15px; /* Reduced space */
}
.modal-content .modal-buttons button {
    padding: 10px 20px; /* Reduced padding */
    border-radius: 8px; /* Modern rounded */
    border: none;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.1s ease, font-family 0.3s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
.modal-content .modal-buttons button.yes {
    background-color: var(--primary-color);
    color: var(--bubble-text-dark);
}
.modal-content .modal-buttons button.yes:hover {
    background-color: var(--secondary-color);
    transform: translateY(-1px);
}
.modal-content .modal-buttons button.no {
    background-color: var(--input-bg);
    color: var(--text-color);
}
.modal-content .modal-buttons button.no:hover {
    background-color: var(--border-color);
    transform: translateY(-1px);
}

/* New Message Notification */
.new-message-notification {
    position: fixed;
    top: 20px; /* Reduced space from top */
    right: 20px; /* Reduced space from right */
    background-color: var(--notification-bg);
    color: var(--notification-text);
    padding: 15px 25px; /* Reduced padding */
    border-radius: 12px; /* Modern rounded */
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 1001;
    display: flex;
    align-items: center;
    gap: 10px;
    opacity: 0;
    transform: translateY(-40px); /* Less pronounced animation */
    transition: opacity 0.5s ease-out, transform 0.5s ease-out, background-color 0.3s ease, color 0.3s ease;
}
.new-message-notification.show {
    opacity: 1;
    transform: translateY(0);
}
.new-message-notification i {
    font-size: 1.6rem; /* Slightly smaller icon */
}

/* Font Style Selector Icon */
.font-style-selector-icon {
    background: none;
    border: none;
    color: var(--accent-color);
    font-size: 1.6rem; /* Slightly smaller */
    cursor: pointer;
    padding: 6px;
    transition: transform 0.2s ease, color 0.3s ease;
    margin-right: 12px; /* Reduced margin */
}
.font-style-selector-icon:hover {
    transform: scale(1.1);
}

/* Theme Selector Icon */
.theme-selector-icon {
    background: none;
    border: none;
    color: var(--accent-color);
    font-size: 1.6rem; /* Slightly smaller */
    cursor: pointer;
    padding: 6px;
    transition: transform 0.2s ease, color 0.3s ease;
    margin-right: 12px; /* Reduced margin */
}
.theme-selector-icon:hover {
    transform: scale(1.1);
}


/* Floating Font Style Selector Panel */
.floating-font-style-selector {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--background-light);
    border: 1px solid var(--border-color); /* Thinner border */
    border-radius: 12px; /* Modern rounded */
    padding: 15px; /* Reduced padding */
    box-shadow: 0 6px 15px rgba(0,0,0,0.4);
    z-index: 1000;
    display: none;
    flex-direction: column;
    gap: 8px; /* Reduced gap */
    max-width: 280px; /* Slightly narrower */
    max-height: 280px; /* Slightly shorter */
    overflow-y: auto;
    transition: background-color 0.3s ease, border-color 0.3s ease;
}

/* Floating Theme Selector Panel */
.floating-theme-selector {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--background-light);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.4);
    z-index: 1000;
    display: none;
    flex-direction: column;
    gap: 8px;
    max-width: 280px;
    max-height: 280px;
    overflow-y: auto;
    transition: background-color 0.3s ease, border-color 0.3s ease;
}


/* Scrollbar styling for font style selector */
.floating-font-style-selector::-webkit-scrollbar,
.floating-theme-selector::-webkit-scrollbar {
    width: 8px;
}
.floating-font-style-selector::-webkit-scrollbar-track,
.floating-theme-selector::-webkit-scrollbar-track {
    background: var(--background-dark);
    border-radius: 8px;
}
.floating-font-style-selector::-webkit-scrollbar-thumb,
.floating-theme-selector::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 8px;
}
.floating-font-style-selector::-webkit-scrollbar-thumb:hover,
.floating-theme-selector::-webkit-scrollbar-thumb:hover {
    background: var(--secondary-color);
}


.floating-font-style-selector.visible {
    display: flex;
}

.floating-theme-selector.visible {
    display: flex;
}

.floating-font-style-selector button,
.floating-theme-selector button {
    background-color: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px; /* Modern rounded */
    padding: 8px 12px; /* Reduced padding */
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 8px;
    cursor: pointer;
    font-size: 0.95rem;
    color: var(--text-color);
    transition: background-color 0.2s ease, transform 0.1s ease, font-family 0.3s ease;
}

.floating-font-style-selector button:hover,
.floating-theme-selector button:hover {
    background-color: var(--primary-color);
    transform: translateX(4px); /* Less pronounced movement */
}

.floating-font-style-selector button i,
.floating-theme-selector button i {
    font-size: 1.1rem;
    color: var(--accent-color);
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    body {
        overflow: auto;
        min-height: -webkit-fill-available;
    }
    .main-container {
        flex-direction: column;
        height: 100%;
    }
    .page {
        width: 100%;
        height: 100vh;
    }
    #friendListPage {
        padding: 15px;
        gap: 12px;
    }
    #friendListPage .header {
        padding-bottom: 10px;
        margin-bottom: 12px;
    }
    #friendListPage .header .user-info {
        font-size: 1.4rem;
    }
    #friendListPage .header .logout-btn {
        padding: 7px 14px;
        font-size: 0.85rem;
    }
    #friendListPage .user-avatar-large {
        width: 70px;
        height: 70px;
        font-size: 3rem;
        margin-bottom: 12px;
    }
    #friendListPage .search-container {
        width: 100%;
        z-index: 2;
    }
    #friendListPage .friends-list-section {
        width: 100%;
        padding: 10px;
        z-index: 1;
    }
    .friend-item-large {
        padding: 8px 12px;
        margin-bottom: 6px;
    }
    .friend-item-large .friend-avatar {
        width: 50px;
        height: 50px;
        font-size: 2.2rem;
        margin-right: 8px;
    }
    .friend-item-large .friend-nickname {
        font-size: 1rem;
    }
    .friend-item-large .latest-message-preview {
        font-size: 0.75rem;
    }
    .friend-item-large .friend-remove-btn {
        font-size: 1.1rem;
    }

    #chatWindow .chat-header {
        padding: 12px 15px;
    }
    #chatWindow .chat-header .back-btn {
        font-size: 1.4rem;
    }
    #chatWindow .chat-header .chat-with-info {
        font-size: 1.4rem;
    }
    #chatWindow .messages {
        padding: 12px;
        padding-top: 60px;
        padding-bottom: 70px;
    }
    #chatWindow .message-input {
        padding: 8px 12px;
        gap: 6px;
    }
    #chatWindow .message-input input {
        padding: 8px 12px;
        font-size: 0.9rem;
    }
    #chatWindow .message-input button {
        padding: 8px 15px;
        font-size: 0.9rem;
    }
    .emoji-picker-btn, .attachment-btn, .camera-btn {
        font-size: 1.4rem;
        padding: 4px;
    }
    .emoji-panel {
        bottom: 60px;
        right: 12px;
        width: 250px;
        height: 160px;
    }
    .new-message-notification {
        top: 12px;
        right: 12px;
        padding: 10px 18px;
        font-size: 0.9rem;
    }

    .font-style-selector-icon,
    .theme-selector-icon {
        font-size: 1.4rem;
        margin-right: 8px;
    }

    .floating-font-style-selector,
    .floating-theme-selector {
        width: 90%;
        padding: 12px;
        max-height: 50vh;
    }

    .attachment-input-container.visible {
        margin-bottom: 4px;
        padding: 6px;
    }
}
</style>
</head>
<body>
<div class="main-container">
    <!-- Authentication Page -->
    <div id="authPage" class="page active">
        <div class="dynamic-background">
            <div></div><div></div><div></div><div></div><div></div>
            <div></div><div></div><div></div><div></div><div></div>
        </div>
        <div id="loginForm" class="auth-container">
            <h2><i class="fas fa-star"></i> Welcome to Messmisan!</h2>
            <input id="loginEmail" type="email" placeholder="Email" />
            <input id="loginPassword" type="password" placeholder="Password" />
            <button onclick="login()"><i class="fas fa-rocket"></i> Blast Off!</button>
            <div class="switch-link" onclick="toggleAuthForm()">Don't have an account? Join the fun! <i class="fas fa-magic"></i></div>
        </div>
        <div id="signupForm" class="auth-container" style="display:none;">
            <h2><i class="fas fa-sparkles"></i> Sign Up for Adventure!</h2>
            <input id="nickname" placeholder="Your Fun Nickname" />
            <input id="email" type="email" placeholder="Your Email" />
            <input id="password" type="password" placeholder="Secret Password" />
            <button onclick="signup()"><i class="fas fa-hat-wizard"></i> Create Account</button>
            <div class="switch-link" onclick="toggleAuthForm()">Already part of the crew? Log in! <i class="fas fa-compass"></i></div>
        </div>
    </div>

    <!-- Friend List Page -->
    <div id="friendListPage" class="page">
        <div class="dynamic-background">
            <div></div><div></div><div></div><div></div><div></div>
            <div></div><div></div><div></div><div></div><div></div>
        </div>
        <div class="header">
            <span class="user-info" id="userNickname">Welcome, User</span>
            <button class="font-style-selector-icon" onclick="toggleFontStylePanel()"><i class="fas fa-font"></i></button>
            <button class="theme-selector-icon" onclick="toggleThemePanel()"><i class="fas fa-palette"></i></button>
            <button class="logout-btn" onclick="logout()"><i class="fas fa-door-open"></i> Bye Bye!</button>
        </div>

        <div class="user-avatar-large">
            <i class="fas fa-user-astronaut"></i> <!-- More fun avatar icon -->
        </div>

        <div class="search-container">
            <input id="searchUser" type="text" placeholder="Find new friends by nickname or email..." onkeyup="searchUsers()" />
            <div class="search-results" id="searchResults">
                <!-- Search results will be displayed here -->
            </div>
        </div>

        <div class="friends-list-section">
            <h3><i class="fas fa-users-line"></i> Your Awesome Friends</h3>
            <div id="friendList">
                <!-- Friends will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Chat Window -->
    <div id="chatWindow" class="page">
        <div class="chat-header">
            <button class="back-btn" onclick="goBackToFriendList()"><i class="fas fa-arrow-left"></i></button>
            <span class="chat-with-info" id="chatWith">
                <span id="chatFriendNickname">None</span>
                <div id="chatFriendStatus" class="online-status-indicator"></div>
            </span>
        </div>
        <div class="messages" id="messages"></div>
        <div class="message-input">
            <!-- Reply Preview Container -->
            <div class="reply-preview" id="replyPreview" style="display: none;">
                <span class="reply-text" id="replyText"></span>
                <button class="cancel-reply-btn" onclick="cancelReply()"><i class="fas fa-times"></i></button>
            </div>

            <!-- Attachment Input Container -->
            <div class="attachment-input-container" id="attachmentInputContainer">
                <div class="file-input-wrapper">
                    <label for="fileInput">
                        <i class="fas fa-paperclip"></i> Attach Files
                    </label>
                    <input type="file" id="fileInput" multiple onchange="handleFileSelect(event)" />
                    <div class="file-preview-container" id="filePreviewContainer">
                        <!-- File previews will be displayed here -->
                    </div>
                </div>
                <div class="attachment-actions">
                    <button class="attachment-clear-btn" onclick="clearAttachments()">
                        <i class="fas fa-times-circle"></i> Clear
                    </button>
                    <button class="send-attachment-btn" id="sendAttachmentButton" onclick="sendAttachment()" style="display: none;">
                        <i class="fas fa-paper-plane"></i> Send Attachments
                    </button>
                </div>
            </div>

            <input id="messageInput" placeholder="Type your super message..." />
            <span class="attachment-btn" onclick="toggleAttachmentInput()"></span>
            <span class="camera-btn" onclick="openCameraModal()"></span> <!-- New Camera Button -->
            <span class="emoji-picker-btn" onclick="toggleEmojiPicker()"></span>
            <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i> Send!</button>
        </div>
    </div>
</div>

<!-- Floating Font Style Selector Panel -->
<div class="floating-font-style-selector" id="fontStyleSelectorPanel">
    <button title="Default Font" onclick="applyFontStyle('default')"><i class="fas fa-align-left"></i> Default</button>
    <button title="Playful Font" onclick="applyFontStyle('playful')"><i class="fas fa-pencil-alt"></i> Playful</button>
    <button title="Fancy Font" onclick="applyFontStyle('fancy')"><i class="fas fa-feather-alt"></i> Fancy</button>
    <button title="Blocky Font" onclick="applyFontStyle('blocky')"><i class="fas fa-cube"></i> Blocky</button>
    <button title="Cute Font" onclick="applyFontStyle('cute')"><i class="fas fa-heart"></i> Cute</button>
    <button title="Handwritten Font" onclick="applyFontStyle('handwritten')"><i class="fas fa-signature"></i> Handwritten</button>
    <button title="Modern Font" onclick="applyFontStyle('modern')"><i class="fas fa-laptop-code"></i> Modern</button>
    <button title="Pixel Font" onclick="applyFontStyle('pixel')"><i class="fas fa-gamepad"></i> Pixel</button>
    <button title="Elegant Font" onclick="applyFontStyle('elegant')"><i class="fas fa-gem"></i> Elegant</button>
    <button title="Funky Font" onclick="applyFontStyle('funky')"><i class="fas fa-headphones-alt"></i> Funky</button>
    <button title="Quirky Font" onclick="applyFontStyle('quirky')"><i class="fas fa-lightbulb"></i> Quirky</button>
    <button title="Tech Font" onclick="applyFontStyle('tech')"><i class="fas fa-microchip"></i> Tech</button>
    <button title="Retro Font" onclick="applyFontStyle('retro')"><i class="fas fa-compact-disc"></i> Retro</button>
    <button title="Storybook Font" onclick="applyFontStyle('storybook')"><i class="fas fa-book-open"></i> Storybook</button>
    <button title="Classic Font" onclick="applyFontStyle('classic')"><i class="fas fa-book"></i> Classic</button>
    <button title="Minimal Font" onclick="applyFontStyle('minimal')"><i class="fas fa-grip-lines"></i> Minimal</button>
    <button title="Clean Font" onclick="applyFontStyle('clean')"><i class="fas fa-broom"></i> Clean</button>
    <button title="Geometric Font" onclick="applyFontStyle('geometric')"><i class="fas fa-shapes"></i> Geometric</button>
    <button title="Serif Display Font" onclick="applyFontStyle('serif-display')"><i class="fas fa-heading"></i> Serif Display</button>
    <button title="Script Font" onclick="applyFontStyle('script')"><i class="fas fa-pen-fancy"></i> Script</button>
    <button title="Marker Font" onclick="applyFontStyle('marker')"><i class="fas fa-highlighter"></i> Marker</button>
    <button title="Bold Modern Font" onclick="applyFontStyle('bold-modern')"><i class="fas fa-bold"></i> Bold Modern</button>
</div>

<!-- Floating Theme Selector Panel -->
<div class="floating-theme-selector" id="themeSelectorPanel">
    <button title="Default Dark" onclick="applyTheme('default')"><i class="fas fa-moon"></i> Default Dark</button>
    <button title="Ocean Breeze" onclick="applyTheme('ocean-breeze')"><i class="fas fa-water"></i> Ocean Breeze</button>
    <button title="Forest Green" onclick="applyTheme('forest-green')"><i class="fas fa-tree"></i> Forest Green</button>
    <button title="Sunset Glow" onclick="applyTheme('sunset-glow')"><i class="fas fa-sun"></i> Sunset Glow</button>
    <button title="Royal Blue" onclick="applyTheme('royal-blue')"><i class="fas fa-crown"></i> Royal Blue</button>
    <button title="Emerald City" onclick="applyTheme('emerald-city')"><i class="fas fa-city"></i> Emerald City</button>
    <button title="Rose Gold" onclick="applyTheme('rose-gold')"><i class="fas fa-gem"></i> Rose Gold</button>
    <button title="Midnight Blue" onclick="applyTheme('midnight-blue')"><i class="fas fa-cloud-moon"></i> Midnight Blue</button>
    <button title="Warm Earth" onclick="applyTheme('warm-earth')"><i class="fas fa-mountain"></i> Warm Earth</button>
    <button title="Cool Gray" onclick="applyTheme('cool-gray')"><i class="fas fa-snowflake"></i> Cool Gray</button>
    <button title="Pastel Dream" onclick="applyTheme('pastel-dream')"><i class="fas fa-cloud"></i> Pastel Dream</button>
</div>

<!-- Add Friend Confirmation Modal -->
<div class="modal-overlay" id="addFriendModal">
    <div class="modal-content">
        <h3 id="addFriendModalText"></h3>
        <div class="modal-buttons">
            <button class="yes" onclick="confirmAddFriend(true)"><i class="fas fa-heart"></i> Yes!</button>
            <button class="no" onclick="confirmAddFriend(false)"><i class="fas fa-times"></i> No</button>
        </div>
    </div>
</div>

<!-- New Message Notification -->
<div id="newMessageNotification" class="new-message-notification">
    <i class="fas fa-bell"></i>
    <span id="notificationText">New message from someone!</span>
</div>

<!-- Camera Modal -->
<div class="camera-modal-overlay" id="cameraModal">
    <div class="camera-modal-content">
        <video id="cameraFeed" autoplay playsinline></video>
        <canvas id="cameraCanvas" style="display:none;"></canvas>
        <div class="camera-controls">
            <button id="startCameraButton" onclick="startCamera()"><i class="fas fa-video"></i> Start Camera</button>
            <button id="takePictureButton" onclick="takePicture()" style="display:none;"><i class="fas fa-camera"></i> Take Picture</button>
            <button id="startRecordingButton" onclick="startRecording()" class="record-btn" style="display:none;"><i class="fas fa-circle"></i> Record Video</button>
            <button id="stopRecordingButton" onclick="stopRecording()" class="stop-record-btn" style="display:none;"><i class="fas fa-stop-circle"></i> Stop Recording</button>
            <button id="sendCapturedButton" onclick="sendCapturedMedia()" class="send-captured-btn" style="display:none;"><i class="fas fa-paper-plane"></i> Send</button>
            <button id="retakeButton" onclick="retakeMedia()" class="retake-btn" style="display:none;"><i class="fas fa-redo"></i> Retake</button>
            <button id="closeCameraButton" onclick="closeCameraModal()"><i class="fas fa-times"></i> Close</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getDatabase, ref, set, get, push, onChildAdded, off, remove, query, orderByChild, startAt, endAt, update, onChildChanged, onValue, onDisconnect, limitToLast } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC1l66DhDXfAMOa2WPxocPWS_H3xGbTO_E",
        authDomain: "tracker-37839.firebaseapp.com",
        projectId: "tracker-37839",
        storageBucket: "tracker-37839.appspot.com",
        messagingSenderId: "569377443416",
        appId: "1:569377443416:web:cb67316b895567be75042d",
        databaseURL: "https://tracker-37839-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    let currentUser = null;
    let currentChatUID = null;
    let currentMessagesRef = null;
    let currentOnChildAddedListener = null;
    let currentOnChildChangedListener = null;
    let pendingFriendToAdd = null;
    let allFriendsListeners = {};
    let friendStatusListeners = {}; // To store listeners for friend online status
    let latestMessageListeners = {}; // To store listeners for latest messages
    let replyingToMessage = null; // Stores the message ID and content for replies

    // --- Google Apps Script Web App URL ---
    // IMPORTANT: REPLACE THIS WITH YOUR DEPLOYED GOOGLE APPS SCRIPT WEB APP URL
    const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxXrqfWlzAoVgGSTYM1ysvx8_Wir1d5urQ9Ctjl8J8XrZCE3oSxMMJdgsb0UGBMHog9/exec"; // e.g., "https://script.google.com/macros/s/AKfycb..."

    // Audio for notification
    const notificationSound = new Audio('https://www.soundjay.com/buttons/beep-07.mp3');

    // --- Attachment Feature Variables ---
    let selectedFiles = []; // Stores File objects for attachments

    // --- Camera Feature Variables ---
    let mediaStream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let capturedMediaBlob = null; // Stores the captured image or video blob

    // --- Page Management ---
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById(pageId).classList.add('active');

        // Show/hide font style selector icon based on the active page
        const fontStyleIconFriendList = document.querySelector('#friendListPage .font-style-selector-icon');
        const themeIconFriendList = document.querySelector('#friendListPage .theme-selector-icon');


        if (fontStyleIconFriendList) {
            fontStyleIconFriendList.style.display = (pageId === 'friendListPage') ? 'block' : 'none';
        }
        if (themeIconFriendList) {
            themeIconFriendList.style.display = (pageId === 'friendListPage') ? 'block' : 'none';
        }
    }

    window.goBackToFriendList = function() {
        showPage('friendListPage');
        // Clear any message listeners when going back
        if (currentMessagesRef && currentOnChildAddedListener) {
            off(currentMessagesRef, 'child_added', currentOnChildAddedListener);
        }
        if (currentMessagesRef && currentOnChildChangedListener) {
            off(currentMessagesRef, 'child_changed', currentOnChildChangedListener);
        }
        currentMessagesRef = null;
        currentChatUID = null;
        document.getElementById("chatFriendNickname").innerText = "None";
        document.getElementById("chatFriendStatus").classList.remove('online'); // Reset status indicator
        clearAttachments(); // Clear any pending attachments
        cancelReply(); // Clear any pending replies
        closeCameraModal(); // Ensure camera is off when leaving chat
    };
    // --- End Page Management ---

    // --- Font Style Management ---
    window.applyFontStyle = function(fontStyleName) {
        const body = document.body;
        // Remove all existing font style classes
        body.classList.remove(
            'font-style-playful',
            'font-style-fancy',
            'font-style-blocky',
            'font-style-cute',
            'font-style-handwritten',
            'font-style-modern',
            'font-style-pixel',
            'font-style-elegant',
            'font-style-funky',
            'font-style-quirky',
            'font-style-tech',
            'font-style-retro',
            'font-style-storybook',
            'font-style-classic',
            'font-style-minimal',
            'font-style-clean',
            'font-style-geometric',
            'font-style-serif-display',
            'font-style-script',
            'font-style-marker',
            'font-style-bold-modern'
        );
        // Add the new font style class, unless it's 'default'
        if (fontStyleName !== 'default') {
            body.classList.add(`font-style-${fontStyleName}`);
        }
        localStorage.setItem('selectedFontStyle', fontStyleName);
        toggleFontStylePanel(); // Hide panel after selection
    };

    window.toggleFontStylePanel = function() {
        const panel = document.getElementById("fontStyleSelectorPanel");
        panel.classList.toggle("visible");
        // Close theme panel if font panel is opened
        document.getElementById("themeSelectorPanel").classList.remove("visible");
    };
    // --- End Font Style Management ---

    // --- Theme Management ---
    window.applyTheme = function(themeName) {
        const body = document.body;
        // Remove all existing theme classes
        body.classList.remove(
            'theme-default',
            'theme-ocean-breeze',
            'theme-forest-green',
            'theme-sunset-glow',
            'theme-royal-blue',
            'theme-emerald-city',
            'theme-rose-gold',
            'theme-midnight-blue',
            'theme-warm-earth',
            'theme-cool-gray',
            'theme-pastel-dream'
        );
        // Add the new theme class
        body.classList.add(`theme-${themeName}`);
        localStorage.setItem('selectedTheme', themeName);
        toggleThemePanel(); // Hide panel after selection
    };

    window.toggleThemePanel = function() {
        const panel = document.getElementById("themeSelectorPanel");
        panel.classList.toggle("visible");
        // Close font panel if theme panel is opened
        document.getElementById("fontStyleSelectorPanel").classList.remove("visible");
    };
    // --- End Theme Management ---


    document.addEventListener('DOMContentLoaded', () => {
        const savedFontStyle = localStorage.getItem('selectedFontStyle') || 'default'; // Default to 'default'
        window.applyFontStyle(savedFontStyle); // Apply font style without hiding panel initially

        const savedTheme = localStorage.getItem('selectedTheme') || 'default'; // Default to 'default'
        window.applyTheme(savedTheme); // Apply theme without hiding panel initially
    });


    window.toggleAuthForm = function () {
        const login = document.getElementById("loginForm");
        const signup = document.getElementById("signupForm");
        login.style.display = login.style.display === "none" ? "flex" : "none";
        signup.style.display = signup.style.display === "none" ? "flex" : "none";
    };

    window.signup = function () {
        const nickname = document.getElementById("nickname").value.trim();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        if (!nickname || !email || !password) return alert("Please fill in all fields.");
        createUserWithEmailAndPassword(auth, email, password)
            .then(userCred => {
                const uid = userCred.user.uid;
                set(ref(db, 'users/' + uid), { nickname, email, status: 'offline', last_online: Date.now() }); // Set initial status
                alert("Signup successful! Please log in.");
                toggleAuthForm();
            })
            .catch(err => alert("Signup error: " + err.message));
    };

    window.login = function () {
        const email = document.getElementById("loginEmail").value.trim();
        const password = document.getElementById("loginPassword").value.trim();
        if (!email || !password) return alert("Please enter email and password.");
        signInWithEmailAndPassword(auth, email, password)
            .then(async userCred => {
                currentUser = userCred.user;
                const uid = currentUser.uid;
                const snap = await get(ref(db, 'users/' + uid));
                if (snap.exists()) {
                    const nickname = snap.val().nickname || "User";
                    document.getElementById("userNickname").innerText = "Welcome, " + nickname;
                    showPage('friendListPage'); // Show friend list page after login

                    // Clear any existing listeners first
                    for (const friendUID in allFriendsListeners) {
                        const { chatRef, listener } = allFriendsListeners[friendUID];
                        off(chatRef, 'child_added', listener);
                    }
                    allFriendsListeners = {};

                    for (const friendUID in friendStatusListeners) {
                        off(ref(db, 'users/' + friendUID + '/status'), 'value', friendStatusListeners[friendUID]);
                    }
                    friendStatusListeners = {};

                    for (const friendUID in latestMessageListeners) {
                        off(latestMessageListeners[friendUID].ref, 'child_added', latestMessageListeners[friendUID].listener);
                    }
                    latestMessageListeners = {};

                    setupPresence(); // Setup online presence
                    loadFriendList();
                    setupNewMessageListeners();
                }
            })
            .catch(err => alert("Login error: " + err.message));
    };

    window.logout = function () {
        if (currentUser) {
            // Set user status to offline on logout
            set(ref(db, 'users/' + currentUser.uid + '/status'), 'offline');
            set(ref(db, 'users/' + currentUser.uid + '/last_online'), Date.now());
        }

        for (const friendUID in allFriendsListeners) {
            const { chatRef, listener } = allFriendsListeners[friendUID];
            off(chatRef, 'child_added', listener);
        }
        allFriendsListeners = {};

        for (const friendUID in friendStatusListeners) {
            off(ref(db, 'users/' + friendUID + '/status'), 'value', friendStatusListeners[friendUID]);
        }
        friendStatusListeners = {};

        for (const friendUID in latestMessageListeners) {
            off(latestMessageListeners[friendUID].ref, 'child_added', latestMessageListeners[friendUID].listener);
        }
        latestMessageListeners = {};

        if (currentMessagesRef && currentOnChildAddedListener) {
            off(currentMessagesRef, 'child_added', currentOnChildAddedListener);
        }
        if (currentMessagesRef && currentOnChildChangedListener) {
            off(currentMessagesRef, 'child_changed', currentOnChildChangedListener);
        }

        signOut(auth).then(() => {
            showPage('authPage'); // Show auth page after logout
            currentChatUID = null;
            document.getElementById("chatFriendNickname").innerText = "None";
            document.getElementById("chatFriendStatus").classList.remove('online');
            document.getElementById("messages").innerHTML = "";
            currentUser = null;
            clearAttachments(); // Clear attachments on logout
            cancelReply(); // Clear any pending replies
            closeCameraModal(); // Ensure camera is off on logout
        });
    };

    // --- Presence System ---
    function setupPresence() {
        const userStatusRef = ref(db, 'users/' + currentUser.uid + '/status');
        const userLastOnlineRef = ref(db, 'users/' + currentUser.uid + '/last_online');
        const connectedRef = ref(db, '.info/connected');

        onValue(connectedRef, (snap) => {
            if (snap.val() === true) {
                // We're connected! Set our status to online.
                set(userStatusRef, 'online');
                set(userLastOnlineRef, Date.now());

                // When I disconnect, set my status to offline and update last_online
                onDisconnect(userStatusRef).set('offline');
                onDisconnect(userLastOnlineRef).set(Date.now());
            } else {
                // We are not connected, Firebase will automatically handle onDisconnect
                // No need to explicitly set offline here, as onDisconnect will do it.
            }
        });
    }
    // --- End Presence System ---

    async function addFriendConfirmed(friendData) {
        const friendUID = friendData.uid;
        const nickname = friendData.nickname || "Friend";

        try {
            const friendSnap = await get(ref(db, 'friends/' + currentUser.uid + '/' + friendUID));
            if (friendSnap.exists()) {
                alert(`${nickname} is already your friend!`);
            } else {
                await set(ref(db, 'friends/' + currentUser.uid + '/' + friendUID), {
                    uid: friendUID,
                    email: friendData.email,
                    nickname: nickname
                });
                alert(`${nickname} added to your friends!`);
                loadFriendList();
                setupNewMessageListenerForFriend(friendUID, nickname); // Ensure this is called for new friends
            }
        } catch (error) {
            console.error("Error adding friend:", error);
            alert("Error adding friend: " + error.message);
        }
    }

    window.removeFriend = function (friendUID, nickname) {
        if (!confirm(`Are you sure you want to remove ${nickname} from your friends?`)) {
            return;
        }
        remove(ref(db, 'friends/' + currentUser.uid + '/' + friendUID))
            .then(() => {
                alert(`${nickname} has been removed.`);
                loadFriendList();
                if (currentChatUID === friendUID) {
                    currentChatUID = null;
                    document.getElementById("chatFriendNickname").innerText = "None";
                    document.getElementById("chatFriendStatus").classList.remove('online');
                    document.getElementById("messages").innerHTML = "";
                    if (currentMessagesRef && currentOnChildAddedListener) {
                        off(currentMessagesRef, 'child_added', currentOnChildAddedListener);
                    }
                    if (currentMessagesRef && currentOnChildChangedListener) {
                        off(currentMessagesRef, 'child_changed', currentOnChildChangedListener);
                    }
                    showPage('friendListPage'); // Go back to friend list if current chat friend is removed
                }
                if (allFriendsListeners[friendUID]) {
                    const { chatRef, listener } = allFriendsListeners[friendUID];
                    off(chatRef, 'child_added', listener);
                    delete allFriendsListeners[friendUID];
                }
                if (friendStatusListeners[friendUID]) {
                    off(ref(db, 'users/' + friendUID + '/status'), 'value', friendStatusListeners[friendUID]);
                    delete friendStatusListeners[friendUID];
                }
                if (latestMessageListeners[friendUID]) {
                    off(latestMessageListeners[friendUID].ref, 'child_added', latestMessageListeners[friendUID].listener);
                    delete latestMessageListeners[friendUID];
                }
            })
            .catch(error => {
                alert("Error removing friend: " + error.message);
            });
    };

    function loadFriendList() {
        const list = document.getElementById("friendList");
        // Clear existing content and remove any duplicate listeners
        list.innerHTML = "";
        for (const friendUID in allFriendsListeners) {
            const { chatRef, listener } = allFriendsListeners[friendUID];
            off(chatRef, 'child_added', listener);
        }
        allFriendsListeners = {};

        for (const friendUID in friendStatusListeners) {
            off(ref(db, 'users/' + friendUID + '/status'), 'value', friendStatusListeners[friendUID]);
        }
        friendStatusListeners = {};

        for (const friendUID in latestMessageListeners) {
            off(latestMessageListeners[friendUID].ref, 'child_added', latestMessageListeners[friendUID].listener);
        }
        latestMessageListeners = {};


        get(ref(db, 'friends/' + currentUser.uid)).then(snapshot => {
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const f = child.val();
                    const friendItem = document.createElement("div");
                    friendItem.className = "friend-item-large";
                    friendItem.onclick = () => startChat(f.uid, f.nickname || "Friend");
                    friendItem.id = `friend-item-${f.uid}`; // Add ID for easy access

                    const avatarDiv = document.createElement("div");
                    avatarDiv.className = "friend-avatar";
                    avatarDiv.innerHTML = `<i class="fas fa-user-circle"></i>`;

                    const friendInfoContainer = document.createElement("div");
                    friendInfoContainer.className = "friend-info-container";

                    const nicknameSpan = document.createElement("span");
                    nicknameSpan.className = "friend-nickname";
                    nicknameSpan.innerText = f.nickname || "Friend";

                    const statusIndicator = document.createElement("div");
                    statusIndicator.className = "online-status-indicator";
                    statusIndicator.id = `status-indicator-${f.uid}`; // Add ID for status updates
                    nicknameSpan.appendChild(statusIndicator); // Append status indicator to nickname span

                    const latestMessagePreview = document.createElement("div");
                    latestMessagePreview.className = "latest-message-preview";
                    latestMessagePreview.id = `latest-message-${f.uid}`;
                    latestMessagePreview.innerText = "No messages yet."; // Default text

                    friendInfoContainer.appendChild(nicknameSpan);
                    friendInfoContainer.appendChild(latestMessagePreview);

                    const removeBtn = document.createElement("button");
                    removeBtn.className = "friend-remove-btn";
                    removeBtn.innerHTML = `<i class="fas fa-times-circle"></i>`;
                    removeBtn.title = `Remove ${f.nickname || "Friend"}`;
                    removeBtn.onclick = (event) => {
                        event.stopPropagation();
                        removeFriend(f.uid, f.nickname || "Friend");
                    };

                    friendItem.appendChild(avatarDiv);
                    friendItem.appendChild(friendInfoContainer);
                    friendItem.appendChild(removeBtn);
                    list.appendChild(friendItem);

                    // Setup listener for friend's online status
                    const friendStatusRef = ref(db, 'users/' + f.uid + '/status');
                    friendStatusListeners[f.uid] = onValue(friendStatusRef, (statusSnap) => {
                        const status = statusSnap.val();
                        const indicator = document.getElementById(`status-indicator-${f.uid}`);
                        if (indicator) {
                            if (status === 'online') {
                                indicator.classList.add('online');
                            } else {
                                indicator.classList.remove('online');
                            }
                        }
                    });

                    // Setup listener for latest message preview
                    const chatId = getChatID(currentUser.uid, f.uid);
                    const chatMessagesRef = query(ref(db, 'messages/' + chatId), limitToLast(1));
                    latestMessageListeners[f.uid] = {
                        ref: chatMessagesRef,
                        listener: onChildAdded(chatMessagesRef, (messageSnapshot) => {
                            const msg = messageSnapshot.val();
                            const previewElement = document.getElementById(`latest-message-${f.uid}`);
                            if (previewElement) {
                                let previewText = msg.text;
                                if (msg.sender === currentUser.uid) {
                                    previewText = `You: ${previewText}`;
                                }
                                previewElement.innerText = previewText.substring(0, 30) + (previewText.length > 30 ? '...' : '');
                            }
                        })
                    };
                });
            } else {
                list.innerHTML = "<p style='text-align: center; color: var(--secondary-color);'>No friends yet. Search and add some!</p>";
            }
        });
    }

    let searchTimeout;
    window.searchUsers = function () {
        clearTimeout(searchTimeout);
        const searchTerm = document.getElementById("searchUser").value.trim().toLowerCase();
        const searchResultsDiv = document.getElementById("searchResults");
        searchResultsDiv.innerHTML = "";

        if (searchTerm.length === 0) {
            searchResultsDiv.classList.remove("visible");
            return;
        }

        searchTimeout = setTimeout(async () => {
            try {
                const usersRef = ref(db, 'users');
                const nicknameQuery = query(usersRef, orderByChild('nickname'), startAt(searchTerm), endAt(searchTerm + '\uf8ff'));
                const nicknameSnapshot = await get(nicknameQuery);

                const emailQuery = query(usersRef, orderByChild('email'), startAt(searchTerm), endAt(searchTerm + '\uf8ff'));
                const emailSnapshot = await get(emailQuery);

                const uniqueUsers = new Map();

                nicknameSnapshot.forEach(child => {
                    const user = child.val();
                    if (child.key !== currentUser.uid) {
                        uniqueUsers.set(child.key, { uid: child.key, ...user });
                    }
                });

                emailSnapshot.forEach(child => {
                    const user = child.val();
                    if (child.key !== currentUser.uid) {
                        uniqueUsers.set(child.key, { uid: child.key, ...user });
                    }
                });

                if (uniqueUsers.size > 0) {
                    uniqueUsers.forEach(user => {
                        const resultItem = document.createElement("div");
                        resultItem.className = "search-result-item";

                        const userInfoDisplay = document.createElement("div");
                        userInfoDisplay.className = "user-info-display";
                        userInfoDisplay.innerHTML = `<i class="fas fa-user"></i> ${user.nickname} (${user.email})`;

                        const addFriendBtn = document.createElement("button");
                        addFriendBtn.className = "add-friend-search-btn";
                        addFriendBtn.innerHTML = `<i class="fas fa-plus-circle"></i>`;
                        addFriendBtn.title = `Add ${user.nickname}`;
                        addFriendBtn.onclick = (event) => {
                            event.stopPropagation();
                            showAddFriendModal(user);
                        };

                        resultItem.appendChild(userInfoDisplay);
                        resultItem.appendChild(addFriendBtn);

                        searchResultsDiv.appendChild(resultItem);
                    });
                    searchResultsDiv.classList.add("visible");
                } else {
                    const noResult = document.createElement("div");
                    noResult.className = "search-result-item";
                    noResult.innerText = "No users found.";
                    searchResultsDiv.appendChild(noResult);
                    searchResultsDiv.classList.add("visible");
                }
            } catch (error) {
                console.error("Error searching users:", error);
                searchResultsDiv.innerHTML = `<div class="search-result-item">Error searching: ${error.message}</div>`;
                searchResultsDiv.classList.add("visible");
            }
        }, 300);
    };

    function showAddFriendModal(user) {
        pendingFriendToAdd = user;
        document.getElementById("addFriendModalText").innerText = `Add ${user.nickname || user.email} as a friend?`;
        document.getElementById("addFriendModal").classList.add("visible");
    }

    window.confirmAddFriend = function(addConfirmed) {
        document.getElementById("addFriendModal").classList.remove("visible");
        if (addConfirmed && pendingFriendToAdd) {
            addFriendConfirmed(pendingFriendToAdd);
        }
        pendingFriendToAdd = null;
    };

    function startChat(friendUID, nickname) {
        if (currentMessagesRef && currentOnChildAddedListener) {
            off(currentMessagesRef, 'child_added', currentOnChildAddedListener);
        }
        if (currentMessagesRef && currentOnChildChangedListener) {
            off(currentMessagesRef, 'child_changed', currentOnChildChangedListener);
        }

        currentChatUID = friendUID;
        document.getElementById("chatFriendNickname").innerText = nickname;

        // Setup listener for chat friend's online status
        const chatFriendStatusRef = ref(db, 'users/' + friendUID + '/status');
        if (friendStatusListeners['chatFriend']) { // Clear previous chat friend listener if exists
            off(chatFriendStatusRef, 'value', friendStatusListeners['chatFriend']);
        }
        friendStatusListeners['chatFriend'] = onValue(chatFriendStatusRef, (statusSnap) => {
            const status = statusSnap.val();
            const indicator = document.getElementById("chatFriendStatus");
            if (indicator) {
                if (status === 'online') {
                    indicator.classList.add('online');
                } else {
                    indicator.classList.remove('online');
                }
            }
        });

        const chatId = getChatID(currentUser.uid, friendUID);
        currentMessagesRef = ref(db, 'messages/' + chatId);
        document.getElementById("messages").innerHTML = "";

        get(currentMessagesRef).then(snapshot => {
            snapshot.forEach(child => {
                const msg = child.val();
                const msgId = child.key;
                appendMessageToChat(msg, msgId);

                // Mark message as seen if it's from the other user and not already seen
                if (msg.sender !== currentUser.uid && !msg.seenBy?.[currentUser.uid]) {
                    update(child.ref, { [`seenBy/${currentUser.uid}`]: true });
                }
            });
            document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
        });

        currentOnChildAddedListener = snapshot => {
            const msg = snapshot.val();
            const msgId = snapshot.key;
            // Only append if it's a new message not already loaded by get()
            if (!document.getElementById(`msg-${msgId}`)) {
                appendMessageToChat(msg, msgId);
            }

            // Update latest message preview in friend list if on friendListPage
            const previewElement = document.getElementById(`latest-message-${currentChatUID}`);
            if (previewElement) {
                let previewText = msg.text;
                if (msg.sender === currentUser.uid) {
                    previewText = `You: ${previewText}`;
                }
                previewElement.innerText = previewText.substring(0, 30) + (previewText.length > 30 ? '...' : '');
            }

            // Mark message as seen if it's from the other user and not already seen
            if (msg.sender !== currentUser.uid && !msg.seenBy?.[currentUser.uid]) {
                update(snapshot.ref, { [`seenBy/${currentUser.uid}`]: true });
            }
            document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
        };
        onChildAdded(currentMessagesRef, currentOnChildAddedListener);

        currentOnChildChangedListener = snapshot => {
            const msg = snapshot.val();
            const msgId = snapshot.key;
            const messageBubble = document.getElementById(`msg-${msgId}`);

            if (messageBubble && msg.sender === currentUser.uid) {
                const seenIndicator = messageBubble.querySelector('.seen-indicator');
                if (seenIndicator) {
                    if (msg.seenBy?.[currentChatUID]) {
                        seenIndicator.innerText = "Seen";
                    } else {
                        seenIndicator.innerText = "Sent";
                    }
                }
            } else if (messageBubble && msg.sender !== currentUser.uid && currentChatUID === friendUID) {
                // If a received message's seenBy status changes (e.g., by another device), update it
                if (!msg.seenBy?.[currentUser.uid]) {
                    update(snapshot.ref, { [`seenBy/${currentUser.uid}`]: true });
                }
            }
        };
        onChildChanged(currentMessagesRef, currentOnChildChangedListener);

        showPage('chatWindow'); // Transition to chat window
    }

    function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

        const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        if (messageDate.getTime() === today.getTime()) {
            return timeString; // Today, just show time
        } else {
            // Not today, show date and time
            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            const dateString = date.toLocaleDateString([], options);
            return `${timeString} ${dateString}`;
        }
    }

    function appendMessageToChat(msg, msgId) {
        const div = document.createElement("div");
        div.className = "bubble " + (msg.sender === currentUser.uid ? "sent" : "received");
        div.id = `msg-${msgId}`;

        // Add swipe indicator element
        const swipeIndicator = document.createElement("div");
        swipeIndicator.className = "swipe-indicator";
        div.appendChild(swipeIndicator);

        // Add reply content if available
        if (msg.replyTo) {
            const replyToDiv = document.createElement("div");
            replyToDiv.className = "reply-content";
            replyToDiv.style.cssText = `
                background-color: rgba(0,0,0,0.2);
                border-left: 3px solid var(--accent-color);
                padding: 5px 10px;
                margin-bottom: 5px;
                border-radius: 5px;
                font-size: 0.8em;
                color: var(--text-color);
                opacity: 0.8;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            `;
            replyToDiv.innerText = `Replying to: "${msg.replyTo.text}"`;
            div.appendChild(replyToDiv);
        }

        const messageContentDiv = document.createElement("div");
        messageContentDiv.className = "message-content";

        if (msg.type === 'attachment' && msg.attachments) {
            let attachmentHtml = '';
            msg.attachments.forEach(att => {
                // Check if it's an image or video to potentially embed
                if (att.mimeType.startsWith('image/')) {
                    attachmentHtml += `<p><a href="${att.url}" target="_blank" style="color: inherit; text-decoration: underline;">
                        <img src="${att.url}" alt="${att.name}" style="max-width: 100%; height: auto; display: block; margin-bottom: 5px; border-radius: 8px;">
                        ${att.name} <i class="fas fa-external-link-alt"></i>
                    </a></p>`;
                } else if (att.mimeType.startsWith('video/')) {
                    attachmentHtml += `<p><a href="${att.url}" target="_blank" style="color: inherit; text-decoration: underline;">
                        <video controls style="max-width: 100%; height: auto; display: block; margin-bottom: 5px; border-radius: 8px;">
                            <source src="${att.url}" type="${att.mimeType}">
                            Your browser does not support the video tag.
                        </video>
                        ${att.name} <i class="fas fa-external-link-alt"></i>
                    </a></p>`;
                } else {
                    attachmentHtml += `<p><a href="${att.url}" target="_blank" style="color: inherit; text-decoration: underline;">
                        <i class="fas fa-file"></i> ${att.name} <i class="fas fa-external-link-alt"></i>
                    </a></p>`;
                }
            });
            messageContentDiv.innerHTML = attachmentHtml;
        } else {
            messageContentDiv.innerText = msg.text;
        }

        div.appendChild(messageContentDiv);

        const messageMetaDiv = document.createElement("div");
        messageMetaDiv.className = "message-meta";

        const timestampSpan = document.createElement("span");
        timestampSpan.className = "timestamp";
        timestampSpan.innerText = formatTimestamp(msg.timestamp);
        messageMetaDiv.appendChild(timestampSpan);

        if (msg.sender === currentUser.uid) {
            const seenIndicator = document.createElement("span");
            seenIndicator.className = "seen-indicator";
            seenIndicator.innerText = msg.seenBy?.[currentChatUID] ? "Seen" : "Sent";
            messageMetaDiv.appendChild(seenIndicator);
        }
        div.appendChild(messageMetaDiv);

        // Add Reply button (for desktop hover)
        const replyBtn = document.createElement("button");
        replyBtn.className = "reply-btn";
        replyBtn.innerHTML = `<i class="fas fa-reply"></i>`;
        replyBtn.title = "Reply to this message";
        replyBtn.onclick = () => setReplyToMessage(msgId, msg.text);
        div.appendChild(replyBtn);

        document.getElementById("messages").appendChild(div);

        // --- Swipe to Reply Logic for Mobile ---
        let startX = 0;
        let currentX = 0;
        let isSwiping = false;
        const swipeThreshold = 50; // Pixels to swipe to trigger reply

        div.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                startX = e.touches[0].clientX;
                isSwiping = true;
                div.style.transition = 'none'; // Disable transition during swipe
                swipeIndicator.style.transition = 'none';
            }
        });

        div.addEventListener('touchmove', (e) => {
            if (isSwiping && e.touches.length === 1) {
                currentX = e.touches[0].clientX;
                const deltaX = currentX - startX;

                // Only allow swipe right for received messages, and swipe left for sent messages
                if (div.classList.contains('received') && deltaX > 0) {
                    div.style.transform = `translateX(${Math.min(deltaX, 80)}px)`; // Limit swipe distance
                    swipeIndicator.style.width = `${Math.min(deltaX, 80)}px`;
                    swipeIndicator.style.opacity = `${Math.min(deltaX / swipeThreshold, 0.5)}`;
                } else if (div.classList.contains('sent') && deltaX < 0) {
                    div.style.transform = `translateX(${Math.max(deltaX, -80)}px)`; // Limit swipe distance
                    swipeIndicator.style.width = `${Math.min(Math.abs(deltaX), 80)}px`;
                    swipeIndicator.style.opacity = `${Math.min(Math.abs(deltaX) / swipeThreshold, 0.5)}`;
                }
            }
        });

        div.addEventListener('touchend', () => {
            if (isSwiping) {
                const deltaX = currentX - startX;
                div.style.transition = 'transform 0.2s ease-out'; // Re-enable transition
                swipeIndicator.style.transition = 'width 0.2s ease-out, opacity 0.2s ease-out';

                if (div.classList.contains('received') && deltaX > swipeThreshold) {
                    setReplyToMessage(msgId, msg.text);
                } else if (div.classList.contains('sent') && deltaX < -swipeThreshold) {
                    setReplyToMessage(msgId, msg.text);
                }

                // Reset position and indicator
                div.style.transform = 'translateX(0)';
                swipeIndicator.style.width = '0';
                swipeIndicator.style.opacity = '0';
                isSwiping = false;
                startX = 0;
                currentX = 0;
            }
        });
        // --- End Swipe to Reply Logic ---
    }

    window.sendMessage = function () {
        const msgInput = document.getElementById("messageInput");
        const msgText = msgInput.value.trim();

        if (selectedFiles.length > 0) {
            // If there are selected files, prioritize sending them as attachments
            sendAttachment();
        } else if (msgText) {
            if (currentChatUID === null) {
                alert("Please select a friend to chat with first.");
                return;
            }
            const chatId = getChatID(currentUser.uid, currentChatUID);
            const messageData = {
                sender: currentUser.uid,
                text: msgText,
                timestamp: Date.now(),
                seenBy: { [currentUser.uid]: true }, // Mark as seen by sender immediately
                type: 'text' // Explicitly mark as text message
            };

            if (replyingToMessage) {
                messageData.replyTo = replyingToMessage;
                cancelReply(); // Clear reply state after sending
            }

            push(ref(db, 'messages/' + chatId), messageData);
            msgInput.value = "";
        } else {
            alert("Please type a message or select files to send.");
        }
    };

    function getChatID(uid1, uid2) {
        return uid1 < uid2 ? uid1 + "_" + uid2 : uid2 + "_" + uid1;
    }

    const emojis = ["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""];

    window.toggleEmojiPicker = function() {
        const panel = document.getElementById("emojiPanel");
        panel.classList.toggle("visible");
        if (panel.classList.contains("visible") && panel.innerHTML === "") {
            panel.innerHTML = emojis.map(emoji =>
                `<div class="emoji-item" onclick="insertEmoji('${emoji}')">${emoji}</div>`
            ).join("");
        }
    };

    window.insertEmoji = function(emoji) {
        const input = document.getElementById("messageInput");
        input.value += emoji;
        input.focus();
        document.getElementById("emojiPanel").classList.remove("visible");
    };

    // --- Attachment Feature Functions ---
    window.toggleAttachmentInput = function() {
        const container = document.getElementById("attachmentInputContainer");
        container.classList.toggle("visible");
        // Hide emoji panel if attachment input is shown
        document.getElementById("emojiPanel").classList.remove("visible");
        // Hide camera button if attachment input is shown
        document.getElementById("cameraModal").classList.remove("visible");
        closeCameraModal(); // Ensure camera is off
    };

    window.handleFileSelect = function(event) {
        const files = event.target.files;
        selectedFiles = Array.from(files); // Convert FileList to Array
        updateFilePreview();
    };

    function updateFilePreview() {
        const previewContainer = document.getElementById("filePreviewContainer");
        const sendAttachmentBtn = document.getElementById("sendAttachmentButton");
        previewContainer.innerHTML = "";

        if (selectedFiles.length > 0) {
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement("div");
                fileItem.className = "file-preview-item";
                fileItem.innerHTML = `
                    <span>${file.name}</span>
                    <button class="remove-file-btn" onclick="removeFile(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                previewContainer.appendChild(fileItem);
            });
            sendAttachmentBtn.style.display = "block"; // Show send button
        } else {
            sendAttachmentBtn.style.display = "none"; // Hide send button
        }
    }

    window.removeFile = function(index) {
        selectedFiles.splice(index, 1); // Remove file from array
        updateFilePreview(); // Update display
    };

    window.clearAttachments = function() {
        selectedFiles = [];
        document.getElementById("fileInput").value = ""; // Clear file input
        updateFilePreview();
        document.getElementById("attachmentInputContainer").classList.remove("visible"); // Hide container
    };

    window.sendAttachment = async function() {
        if (selectedFiles.length === 0) {
            alert("No files selected to send.");
            return;
        }
        if (currentChatUID === null) {
            alert("Please select a friend to chat with first.");
            clearAttachments();
            return;
        }

        const filesToUpload = [];
        for (const file of selectedFiles) {
            filesToUpload.push(new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64Data = reader.result.split(',')[1]; // Get base64 string
                    resolve({
                        fileName: file.name,
                        mimeType: file.type,
                        base64: base64Data
                    });
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            }));
        }

        try {
            // Show a temporary message or loading indicator
            const loadingMessageId = push(ref(db, 'messages/' + getChatID(currentUser.uid, currentChatUID)), {
                sender: currentUser.uid,
                text: "Uploading attachments...",
                timestamp: Date.now(),
                seenBy: { [currentUser.uid]: true },
                type: 'status' // Custom type for loading message
            }).key;

            const uploadedFileDetails = await Promise.all(filesToUpload);

            // Call Google Apps Script to upload files
            const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: JSON.stringify({ files: uploadedFileDetails }) // Send as JSON
            });

            const result = await response.json();

            if (result.success) {
                // Remove loading message
                remove(ref(db, 'messages/' + getChatID(currentUser.uid, currentChatUID) + '/' + loadingMessageId));

                // Send message with attachment links
                const messageData = {
                    sender: currentUser.uid,
                    text: "Sent attachments:", // Optional text
                    timestamp: Date.now(),
                    seenBy: { [currentUser.uid]: true },
                    type: 'attachment', // Custom type for attachments
                    attachments: result.fileLinks // Array of {name, url, mimeType, type}
                };

                if (replyingToMessage) {
                    messageData.replyTo = replyingToMessage;
                    cancelReply(); // Clear reply state after sending
                }

                push(ref(db, 'messages/' + getChatID(currentUser.uid, currentChatUID)), messageData);
                alert("Attachments sent successfully!");
                clearAttachments(); // Clear selected files after sending
            } else {
                // Update loading message to an error message
                update(ref(db, 'messages/' + getChatID(currentUser.uid, currentChatUID) + '/' + loadingMessageId), {
                    text: `Failed to upload attachments: ${result.error}`,
                    type: 'error'
                });
                alert("Failed to upload attachments: " + result.error);
            }
        } catch (error) {
            console.error("Error sending attachments:", error);
            alert("An error occurred while sending attachments: " + error.message);
        }
    };
    // --- End Attachment Feature Functions ---

    // --- Camera Feature Functions ---
    const cameraModal = document.getElementById('cameraModal');
    const cameraFeed = document.getElementById('cameraFeed');
    const cameraCanvas = document.getElementById('cameraCanvas');
    const takePictureButton = document.getElementById('takePictureButton');
    const startRecordingButton = document.getElementById('startRecordingButton');
    const stopRecordingButton = document.getElementById('stopRecordingButton');
    const sendCapturedButton = document.getElementById('sendCapturedButton');
    const retakeButton = document.getElementById('retakeButton');
    const startCameraButton = document.getElementById('startCameraButton');

    window.openCameraModal = function() {
        if (currentChatUID === null) {
            alert("Please select a friend to chat with first before using the camera.");
            return;
        }
        cameraModal.classList.add('visible');
        startCameraButton.style.display = 'block';
        takePictureButton.style.display = 'none';
        startRecordingButton.style.display = 'none';
        stopRecordingButton.style.display = 'none';
        sendCapturedButton.style.display = 'none';
        retakeButton.style.display = 'none';
        cameraFeed.style.display = 'block';
        cameraCanvas.style.display = 'none';
        capturedMediaBlob = null;
        recordedChunks = [];

        // Hide other input options
        document.getElementById("emojiPanel").classList.remove("visible");
        document.getElementById("attachmentInputContainer").classList.remove("visible");
        clearAttachments();
    };

    window.closeCameraModal = function() {
        cameraModal.classList.remove('visible');
        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
            mediaStream = null;
        }
        if (mediaRecorder) {
            mediaRecorder.stop();
            mediaRecorder = null;
        }
        cameraFeed.srcObject = null;
        capturedMediaBlob = null;
        recordedChunks = [];
        // Reset button states
        startCameraButton.style.display = 'block';
        takePictureButton.style.display = 'none';
        startRecordingButton.style.display = 'none';
        stopRecordingButton.style.display = 'none';
        sendCapturedButton.style.display = 'none';
        retakeButton.style.display = 'none';
        cameraFeed.style.display = 'block';
        cameraCanvas.style.display = 'none';
    };

    window.startCamera = async function() {
        try {
            mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            cameraFeed.srcObject = mediaStream;
            startCameraButton.style.display = 'none';
            takePictureButton.style.display = 'block';
            startRecordingButton.style.display = 'block';
        } catch (err) {
            console.error("Error accessing camera: ", err);
            alert("Could not access camera. Please ensure you have a camera and have granted permissions.");
        }
    };

    window.takePicture = function() {
        if (!mediaStream) return;

        cameraCanvas.width = cameraFeed.videoWidth;
        cameraCanvas.height = cameraFeed.videoHeight;
        const context = cameraCanvas.getContext('2d');
        context.drawImage(cameraFeed, 0, 0, cameraCanvas.width, cameraCanvas.height);

        cameraCanvas.toBlob(blob => {
            capturedMediaBlob = blob;
            cameraFeed.style.display = 'none';
            cameraCanvas.style.display = 'block';
            takePictureButton.style.display = 'none';
            startRecordingButton.style.display = 'none';
            sendCapturedButton.style.display = 'block';
            retakeButton.style.display = 'block';
        }, 'image/png'); // You can change format to 'image/jpeg'
    };

    window.startRecording = function() {
        if (!mediaStream) return;

        recordedChunks = [];
        mediaRecorder = new MediaRecorder(mediaStream);

        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };

        mediaRecorder.onstop = () => {
            capturedMediaBlob = new Blob(recordedChunks, { type: 'video/webm' }); // Or 'video/mp4' if supported
            const videoURL = URL.createObjectURL(capturedMediaBlob);
            cameraFeed.src = videoURL; // Play recorded video in the feed
            cameraFeed.controls = true; // Add controls for playback

            takePictureButton.style.display = 'none';
            startRecordingButton.style.display = 'none';
            stopRecordingButton.style.display = 'none';
            sendCapturedButton.style.display = 'block';
            retakeButton.style.display = 'block';
        };

        mediaRecorder.start();
        takePictureButton.style.display = 'none';
        startRecordingButton.style.display = 'none';
        stopRecordingButton.style.display = 'block';
    };

    window.stopRecording = function() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
    };

    window.retakeMedia = function() {
        capturedMediaBlob = null;
        recordedChunks = [];
        cameraFeed.src = null;
        cameraFeed.srcObject = mediaStream; // Show live feed again
        cameraFeed.controls = false; // Remove controls
        cameraFeed.style.display = 'block';
        cameraCanvas.style.display = 'none';
        takePictureButton.style.display = 'block';
        startRecordingButton.style.display = 'block';
        sendCapturedButton.style.display = 'none';
        retakeButton.style.display = 'none';
    };

    window.sendCapturedMedia = async function() {
        if (!capturedMediaBlob) {
            alert("No media captured to send.");
            return;
        }
        if (currentChatUID === null) {
            alert("Please select a friend to chat with first.");
            return;
        }

        const fileName = capturedMediaBlob.type.startsWith('image/') ? `image_${Date.now()}.png` : `video_${Date.now()}.webm`;
        const fileType = capturedMediaBlob.type;

        const reader = new FileReader();
        reader.readAsDataURL(capturedMediaBlob);
        reader.onloadend = async () => {
            const base64Data = reader.result.split(',')[1];

            const filesToUpload = [{
                fileName: fileName,
                mimeType: fileType,
                base64: base64Data
            }];

            try {
                // Show a temporary message or loading indicator
                const loadingMessageId = push(ref(db, 'messages/' + getChatID(currentUser.uid, currentChatUID)), {
                    sender: currentUser.uid,
                    text: "Uploading captured media...",
                    timestamp: Date.now(),
                    seenBy: { [currentUser.uid]: true },
                    type: 'status'
                }).key;

                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: JSON.stringify({ files: filesToUpload })
                });

                const result = await response.json();

                if (result.success) {
                    remove(ref(db, 'messages/' + getChatID(currentUser.uid, currentChatUID) + '/' + loadingMessageId));

                    const messageData = {
                        sender: currentUser.uid,
                        text: capturedMediaBlob.type.startsWith('image/') ? "Sent image:" : "Sent video:",
                        timestamp: Date.now(),
                        seenBy: { [currentUser.uid]: true },
                        type: 'attachment',
                        attachments: result.fileLinks
                    };

                    if (replyingToMessage) {
                        messageData.replyTo = replyingToMessage;
                        cancelReply();
                    }

                    push(ref(db, 'messages/' + getChatID(currentUser.uid, currentChatUID)), messageData);
                    alert("Media sent successfully!");
                    closeCameraModal(); // Close camera after sending
                } else {
                    update(ref(db, 'messages/' + getChatID(currentUser.uid, currentChatUID) + '/' + loadingMessageId), {
                        text: `Failed to upload media: ${result.error}`,
                        type: 'error'
                    });
                    alert("Failed to upload media: " + result.error);
                }
            } catch (error) {
                console.error("Error sending captured media:", error);
                alert("An error occurred while sending captured media: " + error.message);
            }
        };
    };
    // --- End Camera Feature Functions ---


    // --- Reply Functionality ---
    window.setReplyToMessage = function(messageId, messageText) {
        replyingToMessage = { id: messageId, text: messageText };
        const replyPreview = document.getElementById("replyPreview");
        const replyText = document.getElementById("replyText");
        replyText.innerText = messageText;
        replyPreview.style.display = "flex";
        document.getElementById("messageInput").focus();
    };

    window.cancelReply = function() {
        replyingToMessage = null;
        document.getElementById("replyPreview").style.display = "none";
        document.getElementById("replyText").innerText = "";
    };
    // --- End Reply Functionality ---


    document.addEventListener('click', function(event) {
        const emojiPanel = document.getElementById("emojiPanel");
        const emojiBtn = document.querySelector(".emoji-picker-btn");
        if (emojiPanel && emojiBtn && emojiPanel.classList.contains("visible") && !emojiPanel.contains(event.target) && event.target !== emojiBtn) {
            emojiPanel.classList.remove("visible");
        }

        const searchResultsDiv = document.getElementById("searchResults");
        const searchInput = document.getElementById("searchUser");
        if (searchResultsDiv && searchInput && searchResultsDiv.classList.contains("visible") && !searchResultsDiv.contains(event.target) && event.target !== searchInput) {
            if (!event.target.closest('.add-friend-search-btn')) {
                searchResultsDiv.classList.remove("visible");
            }
        }

        const addFriendModal = document.getElementById("addFriendModal");
        const addFriendModalContent = document.querySelector("#addFriendModal .modal-content");
        if (addFriendModal && addFriendModalContent && addFriendModal.classList.contains("visible") && !addFriendModalContent.contains(event.target)) {
            confirmAddFriend(false);
        }

        const fontStyleSelectorPanel = document.getElementById("fontStyleSelectorPanel");
        const fontStyleSelectorIcon = document.querySelector(".font-style-selector-icon");

        // Close font style panel if click is outside and not on its icon
        if (fontStyleSelectorPanel && fontStyleSelectorIcon && fontStyleSelectorPanel.classList.contains("visible") && !fontStyleSelectorPanel.contains(event.target) && !fontStyleSelectorIcon.contains(event.target)) {
            fontStyleSelectorPanel.classList.remove("visible");
        }

        const themeSelectorPanel = document.getElementById("themeSelectorPanel");
        const themeSelectorIcon = document.querySelector(".theme-selector-icon");

        // Close theme panel if click is outside and not on its icon
        if (themeSelectorPanel && themeSelectorIcon && themeSelectorPanel.classList.contains("visible") && !themeSelectorPanel.contains(event.target) && !themeSelectorIcon.contains(event.target)) {
            themeSelectorPanel.classList.remove("visible");
        }

        // Close attachment input if click is outside and not on its icon
        const attachmentInputContainer = document.getElementById("attachmentInputContainer");
        const attachmentBtn = document.querySelector(".attachment-btn");
        if (attachmentInputContainer && attachmentBtn && attachmentInputContainer.classList.contains("visible") && !attachmentInputContainer.contains(event.target) && event.target !== attachmentBtn && !event.target.closest('.attachment-input-container')) {
            attachmentInputContainer.classList.remove("visible");
        }

        // Close camera modal if click is outside and not on its content
        const cameraModalOverlay = document.getElementById("cameraModal");
        const cameraModalContent = document.querySelector("#cameraModal .camera-modal-content");
        const cameraBtn = document.querySelector(".camera-btn");
        if (cameraModalOverlay && cameraModalContent && cameraModalOverlay.classList.contains("visible") && !cameraModalContent.contains(event.target) && event.target !== cameraBtn && !event.target.closest('.camera-modal-content')) {
            closeCameraModal();
        }
    });

    document.getElementById("messageInput").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
        }
    });

    // --- New Message Notification and Seen Functionality ---

    function setupNewMessageListeners() {
        for (const friendUID in allFriendsListeners) {
            const { chatRef, listener } = allFriendsListeners[friendUID];
            off(chatRef, 'child_added', listener);
        }
        allFriendsListeners = {};

        get(ref(db, 'friends/' + currentUser.uid)).then(snapshot => {
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const friend = child.val();
                    setupNewMessageListenerForFriend(friend.uid, friend.nickname);
                });
            }
        });
    }

    function setupNewMessageListenerForFriend(friendUID, friendNickname) {
        const chatId = getChatID(currentUser.uid, friendUID);
        const chatRef = ref(db, 'messages/' + chatId);

        if (allFriendsListeners[friendUID]) {
            off(allFriendsListeners[friendUID].chatRef, 'child_added', allFriendsListeners[friendUID].listener);
        }

        const listener = onChildAdded(chatRef, snapshot => {
            const msg = snapshot.val();
            const msgId = snapshot.key;

            // Update latest message preview in friend list
            const previewElement = document.getElementById(`latest-message-${friendUID}`);
            if (previewElement) {
                let previewText = msg.text || ''; // Default to empty string if no text
                if (msg.type === 'attachment' && msg.attachments && msg.attachments.length > 0) {
                    // Use the 'type' property from the Apps Script response
                    const firstAttachment = msg.attachments[0];
                    if (firstAttachment.type === 'image') {
                        previewText = `Image: ${firstAttachment.name}`;
                    } else if (firstAttachment.type === 'video') {
                        previewText = `Video: ${firstAttachment.name}`;
                    } else {
                        previewText = `File: ${firstAttachment.name}`;
                    }
                    if (msg.attachments.length > 1) {
                        previewText += ` (+${msg.attachments.length - 1} more)`;
                    }
                } else if (msg.replyTo) {
                    previewText = `Reply to "${msg.replyTo.text}": ${previewText}`;
                }
                if (msg.sender === currentUser.uid) {
                    previewText = `You: ${previewText}`;
                }
                previewElement.innerText = previewText.substring(0, 30) + (previewText.length > 30 ? '...' : '');
            }

            if (msg.sender === friendUID) {
                if (currentChatUID === friendUID) {
                    // If in the current chat, mark as seen immediately if not already
                    if (!msg.seenBy?.[currentUser.uid]) {
                        update(snapshot.ref, { [`seenBy/${currentUser.uid}`]: true });
                    }
                    // Append message if it's new and not already in the DOM
                    if (!document.getElementById(`msg-${msgId}`)) {
                        appendMessageToChat(msg, msgId);
                        document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
                    }
                } else {
                    // If not in the current chat, show notification
                    showNotification(`New message from ${friendNickname}!`);
                }
            } else if (msg.sender === currentUser.uid && currentChatUID === friendUID) {
                // If sender is current user and message is in current chat, update seen status
                const messageBubble = document.getElementById(`msg-${msgId}`);
                if (messageBubble) {
                    const seenIndicator = messageBubble.querySelector('.seen-indicator');
                    if (seenIndicator && msg.seenBy?.[friendUID]) {
                        seenIndicator.innerText = "Seen";
                    }
                }
            }
        });

        allFriendsListeners[friendUID] = { chatRef, listener };
    }

    function showNotification(message) {
        const notificationDiv = document.getElementById("newMessageNotification");
        const notificationText = document.getElementById("notificationText");
        notificationText.innerText = message;
        notificationDiv.classList.add("show");
        notificationSound.play();

        setTimeout(() => {
            notificationDiv.classList.remove("show");
        }, 3000);
    }

    // Check auth state on load and initialize UI
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            const uid = currentUser.uid;
            get(ref(db, 'users/' + uid)).then(snap => {
                const nickname = snap.val().nickname || "User";
                document.getElementById("userNickname").innerText = "Welcome, " + nickname;
                showPage('friendListPage'); // Show friend list page
                setupPresence(); // Setup online presence when user is authenticated
                loadFriendList();
                setupNewMessageListeners();
            });
        } else {
            showPage('authPage'); // Show auth page
        }
    });
</script>
</body>
</html>
